/*
  Redactor v10.0
  Updated: September 24, 2014

  http://imperavi.com/redactor/

  Copyright (c) 2009-2014, Imperavi LLC.
  License: http://imperavi.com/redactor/license/

  Usage: $('#content').redactor();
*/
(function(e){"use strict";function i(e,t){return new i.prototype.init(e,t)}if(!Function.prototype.bind){Function.prototype.bind=function(e){var t=this;return function(){return t.apply(e)}}}var t=0;var n=/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.\-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/ig;var r=/https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/;e.fn.redactor=function(t){var n=[];var r=Array.prototype.slice.call(arguments,1);if(typeof t==="string"){this.each(function(){var i=e.data(this,"redactor");var s;if(t.search(/\./)!="-1"){s=t.split(".");if(typeof i[s[0]]!="undefined"){s=i[s[0]][s[1]]}}else{s=i[t]}if(typeof i!=="undefined"&&e.isFunction(s)){var o=s.apply(i,r);if(o!==undefined&&o!==i){n.push(o)}}else{e.error('No such method "'+t+'" for Redactor')}})}else{this.each(function(){e.data(this,"redactor",{});e.data(this,"redactor",i(this,t))})}if(n.length===0)return this;else if(n.length===1)return n[0];else return n};e.Redactor=i;e.Redactor.VERSION="10.0";e.Redactor.modules=["core","build","lang","toolbar","button","dropdown","code","clean","tidy","paragraphize","tabifier","focus","placeholder","autosave","buffer","indent","alignment","paste","keydown","keyup","shortcuts","line","list","block","inline","insert","caret","selection","observe","link","image","file","modal","progress","upload","utils"];e.Redactor.opts={lang:"en",direction:"ltr",plugins:false,focus:false,focusEnd:false,placeholder:false,visual:true,tabindex:false,minHeight:false,maxHeight:false,linebreaks:false,replaceDivs:true,paragraphize:true,cleanStyleOnEnter:false,enterKey:true,cleanOnPaste:true,cleanSpaces:true,pastePlainText:false,autosave:false,autosaveName:false,autosaveInterval:60,autosaveOnChange:false,linkTooltip:true,linkProtocol:"http",linkNofollow:false,linkSize:50,imageEditable:true,imageLink:true,imagePosition:true,imageFloatMargin:"10px",imageResizable:true,imageUpload:false,imageUploadParam:"file",uploadImageField:false,dragImageUpload:true,clipboardImageUpload:false,fileUpload:false,fileUploadParam:"file",dragFileUpload:true,s3:false,convertLinks:true,convertUrlLinks:true,convertImageLinks:true,convertVideoLinks:true,preSpaces:4,tabAsSpaces:false,tabFocus:true,scrollTarget:false,toolbar:true,toolbarFixed:true,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarExternal:false,toolbarOverflow:false,buttonSource:false,buttons:["html","formatting","bold","italic","deleted","unorderedlist","orderedlist","outdent","indent","image","file","link","alignment","horizontalrule"],buttonsHide:[],buttonsHideOnMobile:[],formatting:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],formattingAdd:false,tabifier:true,deniedTags:["html","head","link","body","meta","script","style","applet"],allowedTags:false,removeComments:false,replaceTags:[["strike","del"]],replaceStyles:[["font-weight:\\s?bold","strong"],["font-style:\\s?italic","em"],["text-decoration:\\s?underline","u"],["text-decoration:\\s?line-through","del"]],removeDataAttr:false,removeAttr:false,allowedAttr:false,removeWithoutAttr:["span"],removeEmpty:["p"],activeButtons:["deleted","italic","bold","underline","unorderedlist","orderedlist","alignleft","aligncenter","alignright","justify"],activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline"},shortcuts:{"ctrl+shift+m, meta+shift+m":{func:"inline.removeFormat"},"ctrl+b, meta+b":{func:"inline.format",params:["bold"]},"ctrl+i, meta+i":{func:"inline.format",params:["italic"]},"ctrl+h, meta+h":{func:"inline.format",params:["superscript"]},"ctrl+l, meta+l":{func:"inline.format",params:["subscript"]},"ctrl+k, meta+k":{func:"link.show"},"ctrl+shift+7":{func:"list.toggle",params:["orderedlist"]},"ctrl+shift+8":{func:"list.toggle",params:["unorderedlist"]}},shortcutsAdd:false,buffer:[],rebuffer:[],emptyHtml:"<p>&#x200b;</p>",invisibleSpace:"&#x200b;",imageTypes:["image/png","image/jpeg","image/gif"],indentValue:20,verifiedTags:["a","img","b","strong","sub","sup","i","em","u","small","strike","del","cite","ul","ol","li"],inlineTags:["strong","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small"],alignmentTags:["P","H1","H2","H3","H4","H5","H6","DL","DT","DD","DIV","TD","BLOCKQUOTE","OUTPUT","FIGCAPTION","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE"],blockLevelElements:["PRE","UL","OL","LI"],langs:{en:{html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",link_edit:"Edit link",unlink:"Unlink",formatting:"Formatting",paragraph:"Normal text",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",bold:"Bold",italic:"Italic",fontcolor:"Font Color",backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",center:"Center",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code or Youtube/Vimeo Link",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment",filename:"Name (optional)",edit:"Edit"}}};i.fn=e.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,LEFT:37,LEFT_WIN:91},init:function(n,r){this.$element=e(n);this.uuid=t++;this.rtePaste=false;this.$pasteBox=false;this.loadOptions(r);this.loadModules();this.formatting={};e.merge(this.opts.blockLevelElements,this.opts.alignmentTags);this.reIsBlock=new RegExp("^("+this.opts.blockLevelElements.join("|")+")$","i");this.tidy.setupAllowed();this.lang.load();e.extend(this.opts.shortcuts,this.opts.shortcutsAdd);this.core.setCallback("start");this.start=true;this.build.run()},loadOptions:function(t){this.opts=e.extend({},e.extend(true,{},e.Redactor.opts),this.$element.data(),t)},getModuleMethods:function(e){return Object.getOwnPropertyNames(e).filter(function(t){return typeof e[t]=="function"})},loadModules:function(){var t=e.Redactor.modules.length;for(var n=0;n<t;n++){this.bindModuleMethods(e.Redactor.modules[n])}},bindModuleMethods:function(e){if(typeof this[e]=="undefined")return;this[e]=this[e]();var t=this.getModuleMethods(this[e]);var n=t.length;for(var r=0;r<n;r++){this[e][t[r]]=this[e][t[r]].bind(this)}},core:function(){return{getObject:function(){return e.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getElement:function(){return this.$element},getTextarea:function(){return this.$textarea},getToolbar:function(){return this.$toolbar?this.$toolbar:false},addEvent:function(e){this.core.event=e},getEvent:function(){return this.core.event},setCallback:function(t,n,r){var i=this.opts[t+"Callback"];if(e.isFunction(i)){return typeof r=="undefined"?i.call(this,n):i.call(this,n,r)}else{return typeof r=="undefined"?n:r}},destroy:function(){this.core.setCallback("destroy");this.$element.off(".redactor").removeData("redactor");this.$editor.off(".redactor");this.$editor.removeClass("redactor-editor redactor-linebreaks redactor-placeholder");this.$editor.removeAttr("contenteditable");var t=this.code.get();if(this.build.isTextarea()){this.$box.after(this.$element);this.$box.remove();this.$element.val(t).show()}else{this.$box.after(this.$editor);this.$box.remove();this.$element.html(t).show()}if(this.$pasteBox)this.$pasteBox.remove();if(this.$modalBox)this.$modalBox.remove();if(this.$modalOverlay)this.$modalOverlay.remove();e(".redactor-toolbar-tooltip").remove();clearInterval(this.autosaveInterval)}}},build:function(){return{run:function(){this.build.createContainerBox();this.build.loadContent();this.build.loadEditor();this.build.enableEditor();this.build.setCodeAndCall()},isTextarea:function(){return this.$element[0].tagName==="TEXTAREA"},createContainerBox:function(){this.$box=e('<div class="redactor-box" />')},createTextarea:function(){this.$textarea=e("<textarea />").attr("name",this.build.getTextareaName())},getTextareaName:function(){var e=this.$element.attr("id");if(typeof e=="undefined"){e="content-"+this.uuid}return e},loadContent:function(){var t=this.build.isTextarea()?"val":"html";this.content=e.trim(this.$element[t]())},enableEditor:function(){this.$editor.attr({contenteditable:true,dir:this.opts.direction})},loadEditor:function(){var e=this.build.isTextarea()?"fromTextarea":"fromElement";this.build[e]()},rememberSelection:function(){this.$range=document.getSelection().getRangeAt(0).cloneRange()},fromTextarea:function(){this.$editor=e("<div />");this.$textarea=this.$element;this.$box.insertAfter(this.$element).append(this.$editor).append(this.$element);this.$editor.addClass("redactor-editor");this.$editor.on("click",this.build.rememberSelection);this.$editor.on("keyup",this.build.rememberSelection);this.$element.hide()},fromElement:function(){this.$editor=this.$element;this.build.createTextarea();this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$textarea);this.$editor.addClass("redactor-editor");this.$editor.on("click",this.build.rememberSelection);this.$editor.on("keyup",this.build.rememberSelection);this.$textarea.hide()},setCodeAndCall:function(){this.code.set(this.content);this.build.setOptions();this.build.callEditor();if(!this.opts.visual){setTimeout(e.proxy(this.code.showCode,this),200)}},callEditor:function(){this.build.disableMozillaEditing();this.build.setEvents();this.build.setHelpers();if(this.opts.toolbar){this.opts.toolbar=this.toolbar.init();this.toolbar.build()}this.modal.loadTemplates();this.build.plugins();setTimeout(e.proxy(this.observe.load,this),4);this.core.setCallback("init")},setOptions:function(){e(this.$textarea).attr("dir",this.opts.direction);if(this.opts.linebreaks)this.$editor.addClass("redactor-linebreaks");if(this.opts.tabindex)this.$editor.attr("tabindex",this.opts.tabindex);if(this.opts.minHeight)this.$editor.css("minHeight",this.opts.minHeight);if(this.opts.maxHeight)this.$editor.css("maxHeight",this.opts.maxHeight)},setEvents:function(){this.$editor.on("drop.redactor",e.proxy(function(t){t=t.originalEvent||t;if(window.FormData===undefined||!t.dataTransfer)return true;var n=t.dataTransfer.files.length;if(n===0)return true;else{t.preventDefault();if(this.opts.dragImageUpload||this.opts.dragFileUpload){var r=t.dataTransfer.files;this.upload.directUpload(r[0],t)}}setTimeout(e.proxy(this.clean.clearUnverified,this),1);this.core.setCallback("drop",t)},this));this.$editor.on("click.redactor",e.proxy(function(e){var t="click";if(this.core.getEvent()=="click"||this.core.getEvent()=="arrow"){t=false}this.core.addEvent(t);this.utils.disableSelectAll();this.core.setCallback("click",e)},this));this.$editor.on("paste.redactor",e.proxy(this.paste.init,this));this.$editor.on("keydown.redactor",e.proxy(this.keydown.init,this));this.$editor.on("keyup.redactor",e.proxy(this.keyup.init,this));if(e.isFunction(this.opts.codeKeydownCallback)){this.$textarea.on("keydown.redactor-textarea",e.proxy(this.opts.codeKeydownCallback,this))}if(e.isFunction(this.opts.codeKeyupCallback)){this.$textarea.on("keyup.redactor-textarea",e.proxy(this.opts.codeKeyupCallback,this))}if(e.isFunction(this.opts.focusCallback)){this.$editor.on("focus.redactor",e.proxy(this.opts.focusCallback,this))}var t;e(document).on("mousedown",function(n){t=e(n.target)});this.$editor.on("blur.redactor",e.proxy(function(n){if(this.rtePaste)return;var r=e(t);if(!r.hasClass("redactor-toolbar, redactor-dropdown")&&!r.is("#redactor-modal")&&r.parents(".redactor-toolbar, .redactor-dropdown, #redactor-modal").size()===0){this.utils.disableSelectAll();if(e.isFunction(this.opts.blurCallback))this.core.setCallback("blur",n)}},this))},setHelpers:function(){this.autosave.enable();this.placeholder.enable();if(this.opts.focus)setTimeout(e.proxy(this.focus.setStart,this),100);if(this.opts.focusEnd)setTimeout(e.proxy(this.focus.setEnd,this),100)},plugins:function(){if(!this.opts.plugins)return;if(!RedactorPlugins)return;e.each(this.opts.plugins,e.proxy(function(t,n){if(RedactorPlugins[n]){if(!e.isFunction(RedactorPlugins[n]))return;this[n]=RedactorPlugins[n]();var r=this.getModuleMethods(this[n]);var i=r.length;for(var s=0;s<i;s++){this[n][r[s]]=this[n][r[s]].bind(this)}if(e.isFunction(this[n].init))this[n].init()}},this))},disableMozillaEditing:function(){if(!this.utils.browser("mozilla"))return;try{document.execCommand("enableObjectResizing",false,false);document.execCommand("enableInlineTableEditing",false,false)}catch(e){}}}},lang:function(){return{load:function(){this.opts.curLang=this.opts.langs[this.opts.lang]},get:function(e){return typeof this.opts.curLang[e]!="undefined"?this.opts.curLang[e]:""}}},toolbar:function(){return{init:function(){return{html:{title:this.lang.get("html"),func:"code.toggle"},formatting:{title:this.lang.get("formatting"),dropdown:{p:{title:this.lang.get("paragraph"),func:"block.format"},blockquote:{title:this.lang.get("quote"),func:"block.format"},pre:{title:this.lang.get("code"),func:"block.format"},h1:{title:this.lang.get("header1"),func:"block.format"},h2:{title:this.lang.get("header2"),func:"block.format"},h3:{title:this.lang.get("header3"),func:"block.format"},h4:{title:this.lang.get("header4"),func:"block.format"},h5:{title:this.lang.get("header5"),func:"block.format"}}},bold:{title:this.lang.get("bold"),func:"inline.format"},italic:{title:this.lang.get("italic"),func:"inline.format"},deleted:{title:this.lang.get("deleted"),func:"inline.format"},underline:{title:this.lang.get("underline"),func:"inline.format"},unorderedlist:{title:"&bull; "+this.lang.get("unorderedlist"),func:"list.toggle"},orderedlist:{title:"1. "+this.lang.get("orderedlist"),func:"list.toggle"},outdent:{title:"< "+this.lang.get("outdent"),func:"indent.decrease"},indent:{title:"> "+this.lang.get("indent"),func:"indent.increase"},image:{title:this.lang.get("image"),func:"image.show"},file:{title:this.lang.get("file"),func:"file.show"},link:{title:this.lang.get("link"),dropdown:{link:{title:this.lang.get("link_insert"),func:"link.show"},unlink:{title:this.lang.get("unlink"),func:"link.unlink"}}},alignment:{title:this.lang.get("alignment"),dropdown:{left:{title:this.lang.get("align_left"),func:"alignment.left"},center:{title:this.lang.get("align_center"),func:"alignment.center"},right:{title:this.lang.get("align_right"),func:"alignment.right"},justify:{title:this.lang.get("align_justify"),func:"alignment.justify"}}},horizontalrule:{title:this.lang.get("horizontalrule"),func:"line.insert"}}},build:function(){this.toolbar.hideButtons();this.toolbar.hideButtonsOnMobile();this.toolbar.isButtonSourceNeeded();if(this.opts.buttons.length===0)return;this.$toolbar=this.toolbar.createContainer();this.toolbar.setOverflow();this.toolbar.append();this.toolbar.setFormattingTags();this.toolbar.loadButtons();this.toolbar.setTabindex();this.toolbar.setFixed();if(this.opts.activeButtons){this.$editor.on("mouseup.redactor keyup.redactor focus.redactor",e.proxy(this.observe.buttons,this))}},createContainer:function(){return e("<ul>").addClass("redactor-toolbar").attr("id","redactor-toolbar-"+this.uuid)},setFormattingTags:function(){e.each(this.opts.toolbar.formatting.dropdown,e.proxy(function(t,n){if(e.inArray(t,this.opts.formatting)==-1)delete this.opts.toolbar.formatting.dropdown[t]},this))},loadButtons:function(){e.each(this.opts.buttons,e.proxy(function(t,n){if(!this.opts.toolbar[n])return;if(this.opts.fileUpload===false&&n==="file")return true;if(this.opts.imageUpload===false&&n==="image")return true;var r=this.opts.toolbar[n];this.$toolbar.append(e("<li>").append(this.button.build(n,r)))},this))},append:function(){if(this.opts.toolbarExternal){this.$toolbar.addClass("redactor-toolbar-external");e(this.opts.toolbarExternal).html(this.$toolbar)}else{this.$box.prepend(this.$toolbar)}},setFixed:function(){if(this.utils.isMobile())return;if(this.opts.toolbarExternal)return;if(!this.opts.toolbarFixed)return;this.toolbar.observeScroll();e(this.opts.toolbarFixedTarget).on("scroll.redactor",e.proxy(this.toolbar.observeScroll,this))},setTabindex:function(){this.$toolbar.find("a").attr("tabindex","-1")},setOverflow:function(){if(this.utils.isMobile()&&this.opts.toolbarOverflow){this.$toolbar.addClass("redactor-toolbar-overflow")}},isButtonSourceNeeded:function(){if(this.opts.buttonSource)return;var e=this.opts.buttons.indexOf("html");this.opts.buttons.splice(e,1)},hideButtons:function(){if(this.opts.buttonsHide.length===0)return;e.each(this.opts.buttonsHide,e.proxy(function(e,t){var n=this.opts.buttons.indexOf(t);this.opts.buttons.splice(n,1)},this))},hideButtonsOnMobile:function(){if(!this.utils.isMobile()&&this.opts.buttonsHideOnMobile.length===0)return;e.each(this.opts.buttonsHideOnMobile,e.proxy(function(e,t){var n=this.opts.buttons.indexOf(t);this.opts.buttons.splice(n,1)},this))},observeScroll:function(){var t=e(this.opts.toolbarFixedTarget).scrollTop();var n=1;if(this.opts.toolbarFixedTarget===document){n=this.$box.offset().top}if(t>n-this.opts.toolbarFixedTopOffset){this.toolbar.observeScrollEnable(t,n)}else{this.toolbar.observeScrollDisable()}},observeScrollEnable:function(e,t){var n=this.opts.toolbarFixedTopOffset+e-t;var r=0;var i=t+this.$box.height()+30;var s=this.$box.innerWidth();this.$toolbar.addClass("toolbar-fixed-box");this.$toolbar.css({position:"absolute",width:s,top:n+"px",left:r});this.toolbar.setDropdownsFixed();this.$toolbar.css("visibility",e<i?"visible":"hidden")},observeScrollDisable:function(){this.$toolbar.css({position:"relative",width:"auto",top:0,left:0,visibility:"visible"});this.toolbar.unsetDropdownsFixed();this.$toolbar.removeClass("toolbar-fixed-box")},setDropdownsFixed:function(){var t=this;e(".redactor-dropdown").each(function(){e(this).css({position:"fixed",top:t.$toolbar.innerHeight()+t.opts.toolbarFixedTopOffset})})},unsetDropdownsFixed:function(){var t=this;e(".redactor-dropdown").each(function(){var n=t.$toolbar.innerHeight()+t.$toolbar.offset().top+"px";e(this).css({position:"absolute",top:n})})},setToolbarFixedTopOffset:function(e){this.opts.toolbarFixedTopOffset=e}}},button:function(){return{build:function(t,n){var r=e('<a href="#" class="re-icon re-'+t+'" rel="'+t+'" />');if(n.func||n.command||n.dropdown){r.on("touchstart click",e.proxy(function(e){if(r.hasClass("redactor-button-disabled"))return false;var i="func";var s=n.func;if(n.command){i="command";s=n.command}else if(n.dropdown){i="dropdown";s=false}this.button.onClick(e,t,i,s)},this))}if(n.dropdown){var i=e('<div class="redactor-dropdown redactor-dropdown-box-'+t+'" style="display: none;">');r.data("dropdown",i);this.dropdown.build(t,i,n.dropdown)}if(this.utils.isDesktop()){this.button.createTooltip(r,t,n.title)}return r},createTooltip:function(t,n,r){var i=e("<span>").addClass("redactor-toolbar-tooltip redactor-toolbar-tooltip-"+n).hide().html(r);i.appendTo("body");t.on("mouseover",function(){if(e(this).hasClass("redactor-button-disabled"))return;var n=t.offset();var r=t.innerHeight();var s=t.innerWidth();i.show();i.css({top:n.top+r+"px",left:n.left+s/2-i.innerWidth()/2+"px"})});t.on("mouseout",function(){i.hide()})},onClick:function(t,n,r,i){t.preventDefault();if(this.utils.browser("msie"))t.returnValue=false;if(r=="command"){this.inline.format(i)}else if(r=="dropdown"){this.dropdown.show(t,n)}else{var s;if(e.isFunction(i)){i.call(this,n);this.observe.buttons(t,n)}else if(i.search(/\./)!="-1"){s=i.split(".");if(typeof this[s[0]]!="undefined"){this[s[0]][s[1]](n);this.observe.buttons(t,n)}}else{this[i](n);this.observe.buttons(t,n)}}},get:function(e){return this.$toolbar.find("a.re-"+e)},setActive:function(e){this.button.get(e).addClass("redactor-act")},setInactive:function(e){this.button.get(e).removeClass("redactor-act")},setInactiveAll:function(e){if(typeof e=="undefined"){this.$toolbar.find("a.re-icon").removeClass("redactor-act")}else{this.$toolbar.find("a.re-icon").not(".re-"+e).removeClass("redactor-act")}},setActiveInVisual:function(){this.$toolbar.find("a.re-icon").not("a.re-html").removeClass("redactor-button-disabled")},setInactiveInCode:function(){this.$toolbar.find("a.re-icon").not("a.re-html").addClass("redactor-button-disabled")},changeIcon:function(e,t){this.button.get(e).addClass("re-"+t)},removeIcon:function(e,t){this.button.get(e).removeClass("re-"+t)},setAwesome:function(e,t){var n=this.button.get(e);n.removeClass("redactor-btn-image").addClass("fa-redactor-btn");n.html('<i class="fa '+t+'"></i>')},addCallback:function(t,n){var r=n=="dropdown"?"dropdown":"func";var i=t.attr("rel");t.on("touchstart click",e.proxy(function(e){if(t.hasClass("redactor-button-disabled"))return false;this.button.onClick(e,i,r,n)},this))},addDropdown:function(t,n){var r=t.attr("rel");this.button.addCallback(t,"dropdown");var i=e('<div class="redactor-dropdown redactor-dropdown-box-'+r+'" style="display: none;">');t.data("dropdown",i);if(n){this.dropdown.build(r,i,n)}return i},add:function(t,n){if(!this.opts.toolbar)return;var r=this.button.build(t,{title:n});r.addClass("redactor-btn-image");this.$toolbar.append(e("<li>").append(r));return r},addFirst:function(t,n){if(!this.opts.toolbar)return;var r=this.button.build(t,{title:n});this.$toolbar.prepend(e("<li>").append(r));return r},addAfter:function(t,n,r){if(!this.opts.toolbar)return;var i=this.button.build(n,{title:r});var s=this.button.get(t);if(s.size()!==0)s.parent().after(e("<li>").append(i));else this.$toolbar.append(e("<li>").append(i));return i},addBefore:function(t,n,r){if(!this.opts.toolbar)return;var i=this.button.build(n,{title:r});var s=this.button.get(t);if(s.size()!==0)s.parent().before(e("<li>").append(i));else this.$toolbar.append(e("<li>").append(i));return i},remove:function(e){this.button.get(e).remove()}}},dropdown:function(){return{build:function(t,n,r){if(t=="formatting"&&this.opts.formattingAdd){e.each(this.opts.formattingAdd,e.proxy(function(e,t){var n=t.tag;if(typeof t.class!="undefined"){n=n+"-"+t.class}t.type=this.utils.isBlockTag(t.tag)?"block":"inline";var i=t.type=="inline"?"inline.formatting":"block.formatting";if(this.opts.linebreaks&&t.type=="block"&&t.tag=="p")return;this.formatting[n]={tag:t.tag,style:t.style,"class":t.class,attr:t.attr,data:t.data};r[n]={func:i,title:t.title}},this))}e.each(r,e.proxy(function(r,i){var s=e('<a href="#" class="redactor-dropdown-'+r+'">'+i.title+"</a>");if(t=="formatting")s.addClass("redactor-formatting-"+r);s.on("click",e.proxy(function(e){var t="func";var n=i.func;if(i.command){t="command";n=i.command}else if(i.dropdown){t="dropdown";n=i.dropdown}this.button.onClick(e,r,t,n)},this));n.append(s)},this))},show:function(t,n){if(!this.opts.visual){t.preventDefault();return false}var r=this.button.get(n);var i=r.data("dropdown").appendTo(document.body);if(r.hasClass("dropact")){this.dropdown.hideAll()}else{this.dropdown.hideAll();this.core.setCallback("dropdownShow",{dropdown:i,key:n,button:r});this.button.setActive(n);r.addClass("dropact");var s=r.offset();var o=i.width();if(s.left+o>e(document).width()){s.left-=o}var u=s.left+"px";if(this.$toolbar.hasClass("toolbar-fixed-box")){i.css({position:"fixed",left:u,top:this.$toolbar.innerHeight()+this.opts.toolbarFixedTopOffset}).show()}else{var a=r.innerHeight()+s.top+"px";i.css({position:"absolute",left:u,top:a}).show()}this.core.setCallback("dropdownShown",{dropdown:i,key:n,button:r})}e(document).one("click",e.proxy(this.dropdown.hide,this));this.$editor.one("click",e.proxy(this.dropdown.hide,this));i.on("mouseover",function(){e("html").css("overflow","hidden")});i.on("mouseout",function(){e("html").css("overflow","")});t.stopPropagation()},hideAll:function(){this.$toolbar.find("a.dropact").removeClass("redactor-act").removeClass("dropact");e(".redactor-dropdown").hide();this.core.setCallback("dropdownHide")},hide:function(t){var n=e(t.target);if(!n.hasClass("dropact")){n.removeClass("dropact");this.dropdown.hideAll()}}}},code:function(){return{set:function(t){t=e.trim(t.toString());t=this.clean.onSet(t);this.$editor.html(t);this.code.sync();setTimeout(e.proxy(this.buffer.add,this),15);if(this.start===false)this.observe.load()},get:function(){var e=this.$textarea.val();e=this.tabifier.get(e);return e},sync:function(){setTimeout(e.proxy(this.code.startSync,this),10)},startSync:function(){var e=this.$editor.html();if(this.code.syncCode&&this.code.syncCode==e){return}this.code.syncCode=e;e=this.core.setCallback("syncBefore",e);e=this.clean.onSync(e);this.$textarea.val(e);this.core.setCallback("sync",e);if(this.start===false){this.core.setCallback("change",e)}this.start=false;this.autosave.onChange()},toggle:function(){if(this.opts.visual){this.code.showCode()}else{this.code.showVisual()}},showCode:function(){this.code.offset=this.caret.getOffset();var t=e(window).scrollTop();var n=this.$editor.innerHeight();this.$editor.hide();var r=this.$textarea.val();this.modified=this.clean.removeSpaces(r);r=this.tabifier.get(r);this.$textarea.val(r).height(n).show().focus();this.$textarea.on("keydown.redactor-textarea-indenting",this.code.textareaIndenting);e(window).scrollTop(t);this.opts.visual=false;this.button.setInactiveInCode();this.button.setActive("html");this.$editingHTML=true;this.core.setCallback("source",r)},showVisual:function(){if(this.opts.visual)return;var e=this.$textarea.hide().val();if(this.modified!==this.clean.removeSpaces(e)){this.code.set(e)}this.$editor.show();if(!this.utils.isEmpty(e)){this.placeholder.remove()}this.caret.setOffset(this.code.offset);this.$textarea.off("keydown.redactor-textarea-indenting");this.button.setActiveInVisual();this.button.setInactive("html");this.$editingHTML=false;this.core.setCallback("visual",e);this.observe.load();this.opts.visual=true},textareaIndenting:function(e){if(e.keyCode!==9)return true;var t=this.$textarea;var n=t.get(0).selectionStart;t.val(t.val().substring(0,n)+"  "+t.val().substring(t.get(0).selectionEnd));t.get(0).selectionStart=t.get(0).selectionEnd=n+1;return false}}},clean:function(){return{onSet:function(e){e=this.clean.savePreCode(e);e=e.replace(/\$/g,"&#36;");e=e.replace(/”/g,'"');e=e.replace(/‘/g,"'");e=e.replace(/’/g,"'");if(this.opts.replaceDivs)e=this.clean.replaceDivs(e);if(this.opts.linebreaks)e=this.clean.replaceParagraphsToBr(e);e=this.clean.saveFormTags(e);e=e.replace(/<font(.*?)style="(.*?)"(.*?)>([\w\W]*?)<\/font>/gi,'<span style="$2">$4</span>');e=e.replace(/<font(.*?[^<])>/gi,"");e=e.replace(/<\/font>/gi,"");e=this.tidy.load(e);if(this.opts.paragraphize)e=this.paragraphize.load(e);e=this.clean.setVerified(e);e=this.clean.convertInline(e);return e},onSync:function(t){t=t.replace(/[\u200B-\u200D\uFEFF]/g,"");t=t.replace(/&#x200b;/gi,"");t=t.replace(/&nbsp;/gi," ");if(t.search(/^<p>(||\s||&nbsp;)<\/p>$/i)!=-1){return""}t=this.clean.restoreFormTags(t);var n={"™":"&trade;","©":"&copy;","…":"&hellip;","—":"&mdash;","‐":"&dash;"};e.each(n,function(e,n){t=t.replace(new RegExp(e,"g"),n)});t=t.replace(new RegExp("<br\\s?/?></li>","gi"),"</li>");t=t.replace(new RegExp("</li><br\\s?/?>","gi"),"</li>");t=t.replace(new RegExp('<div(.*?) data-tagblock="redactor"(.*?[^>])>',"gi"),"<div$1$2>");t=t.replace(new RegExp('<(.*?) data-verified="redactor"(.*?[^>])>',"gi"),"<$1$2>");t=t.replace(new RegExp('<span(.*?) rel="(.*?)"(.*?[^>])>',"gi"),"<span$1$3>");t=t.replace(new RegExp('<img(.*?) rel="(.*?)"(.*?[^>])>',"gi"),"<img$1$3>");t=t.replace(new RegExp('<span class="redactor-invisible-space">(.*?)</span>',"gi"),"$1");t=t.replace(/ data-save-url="(.*?[^>])"/gi,"");t=t.replace(/<span(.*?)id="redactor-image-box"(.*?[^>])>([\w\W]*?)<img(.*?)><\/span>/gi,"$3<img$4>");t=t.replace(/<span(.*?)id="redactor-image-resizer"(.*?[^>])>(.*?)<\/span>/gi,"");t=t.replace(/<span(.*?)id="redactor-image-editter"(.*?[^>])>(.*?)<\/span>/gi,"");t=this.tidy.load(t);if(this.opts.linkNofollow){t=t.replace(/<a(.*?)rel="nofollow"(.*?[^>])>/gi,"<a$1$2>");t=t.replace(/<a(.*?[^>])>/gi,'<a$1 rel="nofollow">')}t=t.replace(/<(.*?) data-redactor-tag="(.*?)"(.*?[^>])>/gi,"<$1$3>");t=t.replace(/<(.*?) data-redactor-class="(.*?)"(.*?[^>])>/gi,"<$1$3>");t=t.replace(/<(.*?) data-redactor-style="(.*?)"(.*?[^>])>/gi,"<$1$3>");t=t.replace(new RegExp('<(.*?) data-verified="redactor"(.*?[^>])>',"gi"),"<$1$2>");t=t.replace(new RegExp('<(.*?) data-verified="redactor">',"gi"),"<$1>");return t},onPaste:function(t,n){t=e.trim(t);t=t.replace(/\$/g,"&#36;");t=t.replace(/”/g,'"');t=t.replace(/“/g,'"');t=t.replace(/‘/g,"'");t=t.replace(/’/g,"'");t=t.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," ");t=t.replace(/<span class="Apple-tab-span"[^>]*>\t<\/span>/gi,"  ");t=t.replace(/<span[^>]*>(\s|&nbsp;)<\/span>/gi," ");if(this.opts.pastePlainText){return this.clean.getPlainText(t)}if(!this.utils.isSelectAll()&&typeof n=="undefined"){if(this.utils.isCurrentOrParent(["FIGCAPTION","A"])){return this.clean.getPlainText(t,false)}if(this.utils.isCurrentOrParent("PRE")){return this.clean.getPreCode(t)}if(this.utils.isCurrentOrParent(["BLOCKQUOTE","H1","H2","H3","H4","H5","H6"])){t=this.clean.getOnlyImages(t);if(!this.utils.browser("msie")){var r=this.selection.getBlock();if(r&&r.tagName=="P"){t=t.replace(/<img(.*?)>/gi,"<p><img$1></p>")}}return t}if(this.utils.isCurrentOrParent(["TD"])){t=this.clean.onPasteTidy(t,"td");if(this.opts.linebreaks)t=this.clean.replaceParagraphsToBr(t);t=this.clean.replaceDivsToBr(t);return t}if(this.utils.isCurrentOrParent(["LI"])){return this.clean.onPasteTidy(t,"li")}}t=this.clean.isSingleLine(t,n);if(!this.clean.singleLine){if(this.opts.linebreaks)t=this.clean.replaceParagraphsToBr(t);if(this.opts.replaceDivs)t=this.clean.replaceDivs(t);t=this.clean.saveFormTags(t)}t=this.clean.onPasteIeFixLinks(t);t=this.clean.onPasteWord(t);t=this.clean.onPasteExtra(t);t=this.clean.onPasteTidy(t,"all");if(!this.clean.singleLine&&this.opts.paragraphize){t=this.paragraphize.load(t)}t=this.clean.removeDirtyStyles(t);t=this.clean.onPasteRemoveSpans(t);t=this.clean.onPasteRemoveEmpty(t);t=this.clean.convertInline(t);return t},onPasteWord:function(e){e=e.replace(/<!--[\s\S]*?-->/gi,"");e=e.replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"");e=e.replace(/<img(.*?)v:shapes=(.*?)>/gi,"");e=e.replace(/src="file\:\/\/(.*?)"/,'src=""');e=e.replace(/<p(.*?)class="MsoListParagraphCxSpFirst"([\w\W]*?)<\/p>/gi,"<ul><li$2</li>");e=e.replace(/<p(.*?)class="MsoListParagraphCxSpMiddle"([\w\W]*?)<\/p>/gi,"<li$2</li>");e=e.replace(/<p(.*?)class="MsoListParagraphCxSpLast"([\w\W]*?)<\/p>/gi,"<li$2</li></ul>");e=e.replace(/<p(.*?)class="MsoListParagraph"([\w\W]*?)<\/p>/gi,"<ul><li$2</li></ul>");e=e.replace(/·/g,"");e=e.replace(/<p class="Mso(.*?)"/gi,"<p");e=e.replace(/ class=\"(mso[^\"]*)\"/gi,"");e=e.replace(/ class=(mso\w+)/gi,"");e=e.replace(/<o:p(.*?)>([\w\W]*?)<\/o:p>/gi,"$2");if(this.opts.cleanSpaces){e=e.replace(/(\s|&nbsp;)+/g," ")}e=e.replace(/\n/g," ");e=e.replace(/<p>\n?<li>/gi,"<li>");return e},onPasteExtra:function(e){e=e.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2");e=e.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3");e=e.replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>/gi,'<span style="font-weight: bold;"><span style="font-style: italic;">');e=e.replace(/<span[^>]*font-style: italic[^>]*>/gi,'<span style="font-style: italic;">');e=e.replace(/<span[^>]*font-weight: bold[^>]*>/gi,'<span style="font-weight: bold;">');e=e.replace(/<span[^>]*text-decoration: underline[^>]*>/gi,'<span style="text-decoration: underline;">');e=e.replace(/<img>/gi,"");e=e.replace(/\n{3,}/gi,"\n");e=e.replace(/<font(.*?)>([\w\W]*?)<\/font>/gi,"$2");e=e.replace(/<p><p>/gi,"<p>");e=e.replace(/<\/p><\/p>/gi,"</p>");e=e.replace(/<li>(\s*|\t*|\n*)<p>/gi,"<li>");e=e.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,"</li>");e=e.replace(/<\/p>\s<p/gi,"</p><p");e=e.replace(/<img src="webkit-fake-url\:\/\/(.*?)"(.*?)>/gi,"");e=e.replace(/<p>•([\w\W]*?)<\/p>/gi,"<li>$1</li>");if(this.utils.browser("mozilla")){e=e.replace(/<br\s?\/?>$/gi,"")}return e},onPasteTidy:function(e,t){var n=["span","a","pre","blockquote","small","em","strong","code","kbd","mark","address","cite","var","samp","dfn","sup","sub","b","i","u","del","ol","ul","li","dl","dt","dd","p","br","video","audio","embed","param","object","img","table","td","th","tr","tbody","tfoot","thead","h1","h2","h3","h4","h5","h6"];var r=false;var i=[["a","*"],["img",["src","alt"]],["span",["class","rel","data-verified"]],["video","*"],["audio","*"],["embed","*"],["object","*"],["param","*"],["source","*"]];if(t=="all"){r=["p","span","h1","h2","h3","h4","h5","h6"];i=[["table","class"],["td",["colspan","rowspan"]],["a","*"],["img",["src","alt","data-redactor-inserted-image"]],["span",["class","rel","data-verified"]],["video","*"],["audio","*"],["embed","*"],["object","*"],["param","*"],["source","*"]]}else if(t=="td"){n=["ul","ol","li","span","a","small","em","strong","code","kbd","mark","cite","var","samp","dfn","sup","sub","b","i","u","del","ol","ul","li","dl","dt","dd","br","video","audio","embed","param","object","img","h1","h2","h3","h4","h5","h6"]}else if(t=="li"){n=["ul","ol","li","span","a","small","em","strong","code","kbd","mark","cite","var","samp","dfn","sup","sub","b","i","u","del","br","video","audio","embed","param","object","img"]}var s={deniedTags:false,allowedTags:n,removeComments:true,removePhp:true,removeAttr:false,allowedAttr:i,removeEmpty:r};return this.tidy.load(e,s)},onPasteRemoveEmpty:function(e){e=e.replace(/<(p|h[1-6])>(|\s|\n|\t|<br\s?\/?>)<\/(p|h[1-6])>/gi,"");if(!this.opts.linebreaks)e=e.replace(/<br>$/i,"");return e},onPasteRemoveSpans:function(e){e=e.replace(/<span>(.*?)<\/span>/gi,"$1");e=e.replace(/<span[^>]*>\s|&nbsp;<\/span>/gi," ");return e},onPasteIeFixLinks:function(t){if(!this.utils.browser("msie"))return t;var n=e.trim(t);if(n.search(/^<a(.*?)>(.*?)<\/a>$/i)===0){t=t.replace(/^<a(.*?)>(.*?)<\/a>$/i,"$2")}return t},isSingleLine:function(e,t){this.clean.singleLine=false;if(!this.utils.isSelectAll()&&typeof t=="undefined"){var n=this.opts.blockLevelElements.join("|").replace("P|","").replace("DIV|","");var r=e.match(new RegExp("</("+n+")>","gi"));var i=e.match(/<\/(p|div)>/gi);if(!r&&(i===null||i&&i.length<=1)){var s=e.match(/<br\s?\/?>/gi);var o=e.match(/<img(.*?[^>])>/gi);if(!s&&!o){this.clean.singleLine=true;e=e.replace(/<\/?(p|div)(.*?)>/gi,"")}}}return e},stripTags:function(e,t){t=(((t||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var n=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;return e.replace(n,function(e,n){return t.indexOf("<"+n.toLowerCase()+">")>-1?e:""})},savePreCode:function(t){var n=t.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/gi);if(n!==null){e.each(n,e.proxy(function(e,n){var r=n.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/i);r[3]=r[3].replace(/<br\s?\/?>/g,"\n");r[3]=r[3].replace(/&nbsp;/g," ");if(this.opts.preSpaces){r[3]=r[3].replace(/\t/g,Array(this.opts.preSpaces+1).join(" "))}r[3]=this.clean.encodeEntities(r[3]);r[3]=r[3].replace(/\$/g,"&#36;");t=t.replace(n,"<"+r[1]+r[2]+">"+r[3]+"</"+r[1]+">")},this))}return t},getTextFromHtml:function(t){t=t.replace(/<br\s?\/?>|<\/H[1-6]>|<\/p>|<\/div>|<\/li>|<\/td>/gi,"\n");var n=document.createElement("div");n.innerHTML=t;t=n.textContent||n.innerText;return e.trim(t)},getPlainText:function(e,t){e=this.clean.getTextFromHtml(e);e=e.replace(/\n/g,"<br />");if(this.opts.paragraphize&&typeof t=="undefined"){e=this.paragraphize.load(e)}return e},getPreCode:function(e){e=e.replace(/<img(.*?) style="(.*?)"(.*?[^>])>/gi,"<img$1$3>");e=e.replace(/<img(.*?)>/gi,"&lt;img$1&gt;");e=this.clean.getTextFromHtml(e);if(this.opts.preSpaces){e=e.replace(/\t/g,Array(this.opts.preSpaces+1).join(" "))}e=this.clean.encodeEntities(e);return e},getOnlyImages:function(e){e=e.replace(/<img(.*?)>/gi,"[img$1]");e=e.replace(/<(.*?)>/gi,"");e=e.replace(/\[img(.*?)\]/gi,"<img$1>");return e},getOnlyLinksAndImages:function(e){e=e.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]');e=e.replace(/<img(.*?)>/gi,"[img$1]");e=e.replace(/<(.*?)>/gi,"");e=e.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>');e=e.replace(/\[img(.*?)\]/gi,"<img$1>");return e},encodeEntities:function(e){e=String(e).replace(/&/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');return e.replace(/&/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},removeDirtyStyles:function(t){if(this.utils.browser("msie"))return t;var n=document.createElement("div");n.innerHTML=t;this.clean.clearUnverifiedRemove(e(n));t=n.innerHTML;e(n).remove();return t},clearUnverified:function(){if(this.utils.browser("msie"))return;this.clean.clearUnverifiedRemove(this.$editor);var e=this.$editor.find("h1, h2, h3, h4, h5, h6");e.find("span").removeAttr("style");e.find(this.opts.verifiedTags.join(", ")).removeAttr("style");this.code.sync()},clearUnverifiedRemove:function(t){t.find(this.opts.verifiedTags.join(", ")).removeAttr("style");t.find("span").not('[data-verified="redactor"]').removeAttr("style");t.find('span[data-verified="redactor"], img[data-verified="redactor"]').each(function(t,n){var r=e(n);r.attr("style",r.attr("rel"))})},setVerified:function(e){if(this.utils.browser("msie"))return e;e=e.replace(new RegExp("<img(.*?[^>])>","gi"),'<img$1 data-verified="redactor">');e=e.replace(new RegExp("<span(.*?)>","gi"),'<span$1 data-verified="redactor">');var t=e.match(new RegExp('<(span|img)(.*?)style="(.*?)"(.*?[^>])>',"gi"));if(t){var n=t.length;for(var r=0;r<n;r++){var i=t[r].replace(/style="(.*?)"/i,'style="$1" rel="$1"');var s=t[r].replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");e=e.replace(new RegExp(s,"gi"),i)}}return e},convertInline:function(t){var n=e("<div />").html(t);var r=this.opts.inlineTags;r.push("span");n.find(r.join(",")).each(function(){var t=e(this);var n=this.tagName.toLowerCase();t.attr("data-redactor-tag",n);if(n=="span"){if(t.attr("style"))t.attr("data-redactor-style",t.attr("style"));else if(t.attr("class"))t.attr("data-redactor-class",t.attr("class"))}});t=n.html();n.remove();return t},normalizeLists:function(){this.$editor.find("li").each(function(t,n){var r=e(n).next();if(r.length!==0&&(r[0].tagName=="UL"||r[0].tagName=="OL")){e(n).append(r)}})},removeSpaces:function(e){e=e.replace(/\n/g,"");e=e.replace(/[\t]*/g,"");e=e.replace(/\n\s*\n/g,"\n");e=e.replace(/^[\s\n]*/g," ");e=e.replace(/[\s\n]*$/g," ");e=e.replace(/>\s{2,}</g,"> <");e=e.replace(/\n\n/g,"\n");e=e.replace(/[\u200B-\u200D\uFEFF]/g,"");return e},replaceDivs:function(e){if(this.opts.linebreaks){e=e.replace(/<div><br\s?\/?><\/div>/gi,"<br />");e=e.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"$2<br />")}else{e=e.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p$1>$2</p>")}return e},replaceDivsToBr:function(e){e=e.replace(/<div\s(.*?)>/gi,"<p>");e=e.replace(/<div><br\s?\/?><\/div>/gi,"<br /><br />");e=e.replace(/<div>([\w\W]*?)<\/div>/gi,"$1<br /><br />");return e},replaceParagraphsToBr:function(e){e=e.replace(/<p\s(.*?)>/gi,"<p>");e=e.replace(/<p><br\s?\/?><\/p>/gi,"<br />");e=e.replace(/<p>([\w\W]*?)<\/p>/gi,"$1<br /><br />");e=e.replace(/(<br\s?\/?>){1,}\n?<\/blockquote>/gi,"</blockquote>");return e},saveFormTags:function(e){return e.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>')},restoreFormTags:function(e){return e.replace(/<section(.*?) rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,"<form$1$2>$3</form>")}}},tidy:function(){return{setupAllowed:function(){if(this.opts.allowedTags)this.opts.deniedTags=false;if(this.opts.allowedAttr)this.opts.removeAttr=false;if(this.opts.linebreaks)return;var e=["p","section"];if(this.opts.allowedTags)this.tidy.addToAllowed(e);if(this.opts.deniedTags)this.tidy.removeFromDenied(e)},addToAllowed:function(t){var n=t.length;for(var r=0;r<n;r++){if(e.inArray(t[r],this.opts.allowedTags)==-1){this.opts.allowedTags.push(t[r])}}},removeFromDenied:function(t){var n=t.length;for(var r=0;r<n;r++){var i=e.inArray(t[r],this.opts.deniedTags);if(i!=-1){this.opts.deniedTags.splice(i,1)}}},load:function(t,n){this.tidy.settings={deniedTags:this.opts.deniedTags,allowedTags:this.opts.allowedTags,removeComments:this.opts.removeComments,replaceTags:this.opts.replaceTags,replaceStyles:this.opts.replaceStyles,removeDataAttr:this.opts.removeDataAttr,removeAttr:this.opts.removeAttr,allowedAttr:this.opts.allowedAttr,removeWithoutAttr:this.opts.removeWithoutAttr,removeEmpty:this.opts.removeEmpty};e.extend(this.tidy.settings,n);t=this.tidy.removeComments(t);t=this.tidy.replaceTags(t);this.tidy.$div=e("<div />").append(t);this.tidy.replaceStyles();this.tidy.removeTags();this.tidy.removeAttr();this.tidy.removeEmpty();this.tidy.removeParagraphsInLists();this.tidy.removeDataAttr();this.tidy.removeWithoutAttr();t=this.tidy.$div.html();this.tidy.$div.remove();return t},removeComments:function(e){if(!this.tidy.settings.removeComments)return e;return e.replace(/<!--[\s\S]*?-->/gi,"")},replaceTags:function(e){if(!this.tidy.settings.replaceTags)return e;var t=this.tidy.settings.replaceTags.length;for(var n=0;n<t;n++){var r=new RegExp("<"+this.tidy.settings.replaceTags[n][0]+"(.*?[^>])>","gi");e=e.replace(r,"<"+this.tidy.settings.replaceTags[n][1]+"$1>");r=new RegExp("</"+this.tidy.settings.replaceTags[n][0]+">","gi");e=e.replace(r,"</"+this.tidy.settings.replaceTags[n][1]+">")}return e},replaceStyles:function(){if(!this.tidy.settings.replaceStyles)return;var t=this.tidy.settings.replaceStyles.length;this.tidy.$div.find("span").each(e.proxy(function(n,r){var i=e(r);var s=i.attr("style");for(var o=0;o<t;o++){if(s&&s.match(new RegExp("^"+this.tidy.settings.replaceStyles[o][0],"i"))){var u=this.tidy.settings.replaceStyles[o][1];i.replaceWith(function(){var t=document.createElement(u);return e(t).append(e(this).contents())})}}},this))},removeTags:function(){if(!this.tidy.settings.deniedTags&&this.tidy.settings.allowedTags){this.tidy.$div.find("*").not(this.tidy.settings.allowedTags.join(",")).contents().unwrap()}if(this.tidy.settings.deniedTags){this.tidy.$div.find(this.tidy.settings.deniedTags.join(",")).contents().unwrap()}},removeAttr:function(){var t;if(!this.tidy.settings.removeAttr&&this.tidy.settings.allowedAttr){var n=[],r=[];t=this.tidy.settings.allowedAttr.length;for(var i=0;i<t;i++){n.push(this.tidy.settings.allowedAttr[i][0]);r.push(this.tidy.settings.allowedAttr[i][1])}this.tidy.$div.find("*").each(e.proxy(function(t,i){var s=e(i);var o=e.inArray(s[0].tagName.toLowerCase(),n);var u=this.tidy.removeAttrGetRemoves(o,r,s);if(u){e.each(u,function(e,t){s.removeAttr(t)})}},this))}if(this.tidy.settings.removeAttr){t=this.tidy.settings.removeAttr.length;for(var i=0;i<t;i++){var s=this.tidy.settings.removeAttr[i][1];if(e.isArray(s))s=s.join(" ");this.tidy.$div.find(this.tidy.settings.removeAttr[i][0]).removeAttr(s)}}},removeAttrGetRemoves:function(t,n,r){var i=[];if(t==-1){e.each(r[0].attributes,function(e,t){i.push(t.name)})}else if(n[t]=="*"){i=[]}else{e.each(r[0].attributes,function(r,s){if(e.isArray(n[t])){if(e.inArray(s.name,n[t])==-1){i.push(s.name)}}else if(n[t]!=s.name){i.push(s.name)}})}return i},removeAttrs:function(t,n){n=new RegExp(n,"g");return t.each(function(){var t=e(this);var r=this.attributes.length-1;for(var i=r;i>=0;i--){var s=this.attributes[i];if(s&&s.specified&&s.name.search(n)>=0){t.removeAttr(s.name)}}})},removeEmpty:function(){if(!this.tidy.settings.removeEmpty)return;this.tidy.$div.find(this.tidy.settings.removeEmpty.join(",")).each(function(){var t=e(this);var n=t.text();n=n.replace(/[\u200B-\u200D\uFEFF]/g,"");n=n.replace(/&nbsp;/gi,"");n=n.replace(/\s/g,"");if(n===""&&t.children().length===0){t.remove()}})},removeParagraphsInLists:function(){this.tidy.$div.find("li p").contents().unwrap()},removeDataAttr:function(){if(!this.tidy.settings.removeDataAttr)return;var t=this.tidy.settings.removeDataAttr;if(e.isArray(this.tidy.settings.removeDataAttr))t=this.tidy.settings.removeDataAttr.join(",");this.tidy.removeAttrs(this.tidy.$div.find(t),"^(data-)")},removeWithoutAttr:function(){if(!this.tidy.settings.removeWithoutAttr)return;this.tidy.$div.find(this.tidy.settings.removeWithoutAttr.join(",")).each(function(){if(this.attributes.length===0){e(this).contents().unwrap()}})}}},paragraphize:function(){return{load:function(t){if(this.opts.linebreaks)return t;if(t===""||t==="<p></p>")return this.opts.emptyHtml;this.paragraphize.blocks=["table","div","pre","form","ul","ol","h1","h2","h3","h4","h5","h6","dl","blockquote","figcaption","address","section","header","footer","aside","article","object","style","script","iframe","select","input","textarea","button","option","map","area","math","hr","fieldset","legend","hgroup","nav","figure","details","menu","summary","p"];t=t+"\n";this.paragraphize.safes=[];this.paragraphize.z=0;t=t.replace(/(<br\s?\/?>){1,}\n?<\/blockquote>/gi,"</blockquote>");t=this.paragraphize.getSafes(t);t=this.paragraphize.getSafesComments(t);t=this.paragraphize.replaceBreaksToNewLines(t);t=this.paragraphize.replaceBreaksToParagraphs(t);t=this.paragraphize.clear(t);t=this.paragraphize.restoreSafes(t);t=t.replace(new RegExp("<br\\s?/?>\n?<("+this.paragraphize.blocks.join("|")+")(.*?[^>])>","gi"),"<p><br /></p>\n<$1$2>");return e.trim(t)},getSafes:function(t){var n=e("<div />").append(t);n.find("blockquote p").replaceWith(function(){return e(this).append("<br />").contents()});t=n.html();n.find(this.paragraphize.blocks.join(", ")).each(e.proxy(function(e,n){this.paragraphize.z++;this.paragraphize.safes[this.paragraphize.z]=n.outerHTML;t=t.replace(n.outerHTML,"\n{replace"+this.paragraphize.z+"}")},this));return t},getSafesComments:function(t){var n=t.match(/<!--([\w\W]*?)-->/gi);if(!n)return t;e.each(n,e.proxy(function(e,n){this.paragraphize.z++;this.paragraphize.safes[this.paragraphize.z]=n;t=t.replace(n,"\n{replace"+this.paragraphize.z+"}")},this));return t},restoreSafes:function(t){e.each(this.paragraphize.safes,function(e,n){t=t.replace("{replace"+e+"}",n)});return t},replaceBreaksToParagraphs:function(e){var t=e.split(new RegExp("\n","g"),-1);e="";if(t){var n=t.length;for(var r=0;r<n;r++){if(!t.hasOwnProperty(r))return;if(t[r].search("{replace")==-1){t[r]=t[r].replace(/<p>\n\t?<\/p>/gi,"");t[r]=t[r].replace(/<p><\/p>/gi,"");if(t[r]!==""){e+="<p>"+t[r].replace(/^\n+|\n+$/g,"")+"</p>"}}else e+=t[r]}}return e},replaceBreaksToNewLines:function(e){e=e.replace(/<br \/>\s*<br \/>/gi,"\n\n");e=e.replace(/<br\s?\/?>\n?<br\s?\/?>/gi,"\n<br /><br />");e=e.replace(new RegExp("\r\n","g"),"\n");e=e.replace(new RegExp("\r","g"),"\n");e=e.replace(new RegExp("/\n\n+/"),"g","\n\n");return e},clear:function(e){e=e.replace(new RegExp("</blockquote></p>","gi"),"</blockquote>");e=e.replace(new RegExp("<p></blockquote>","gi"),"</blockquote>");e=e.replace(new RegExp("<p><blockquote>","gi"),"<blockquote>");e=e.replace(new RegExp("<blockquote></p>","gi"),"<blockquote>");e=e.replace(new RegExp("<p><p ","gi"),"<p ");e=e.replace(new RegExp("<p><p>","gi"),"<p>");e=e.replace(new RegExp("</p></p>","gi"),"</p>");e=e.replace(new RegExp("<p>\\s?</p>","gi"),"");e=e.replace(new RegExp("\n</p>","gi"),"</p>");e=e.replace(new RegExp("<p>  ? ?\n?<p>","gi"),"<p>");e=e.replace(new RegExp("<p> *</p>","gi"),"");return e}}},tabifier:function(){return{get:function(e){if(!this.opts.tabifier)return e;var t=["area","body","head","hr","i?frame","link","meta","noscript","style","script","table","tbody","thead","tfoot"];var n=["li","dt","dt","h[1-6]","option","script"];var r=["blockquote","div","dl","fieldset","form","frameset","map","ol","p","pre","select","td","th","tr","ul"];this.tabifier.lineBefore=new RegExp("^<(/?"+t.join("|/?")+"|"+n.join("|")+")[ >]");this.tabifier.lineAfter=new RegExp("^<(br|/?"+t.join("|/?")+"|/"+n.join("|/")+")[ >]");this.tabifier.newLevel=new RegExp("^</?("+r.join("|")+")[ >]");var i=0,s=e.length,o=0,u=null,a=null,f="",l="",c="";this.tabifier.cleanlevel=0;for(;i<s;i++){o=i;if(-1==e.substr(i).indexOf("<")){l+=e.substr(i);return this.tabifier.finish(l)}while(o<s&&e.charAt(o)!="<"){o++}if(i!=o){c=e.substr(i,o-i);if(!c.match(/^\s{2,}$/g)){if("\n"==l.charAt(l.length-1))l+=this.tabifier.getTabs();else if("\n"==c.charAt(0)){l+="\n"+this.tabifier.getTabs();c=c.replace(/^\s+/,"")}l+=c}if(c.match(/\n/))l+="\n"+this.tabifier.getTabs()}u=o;while(o<s&&">"!=e.charAt(o)){o++}f=e.substr(u,o-u);i=o;var h;if("!--"==f.substr(1,3)){if(!f.match(/--$/)){while("-->"!=e.substr(o,3)){o++}o+=2;f=e.substr(u,o-u);i=o}if("\n"!=l.charAt(l.length-1))l+="\n";l+=this.tabifier.getTabs();l+=f+">\n"}else if("!"==f[1]){l=this.tabifier.placeTag(f+">",l)}else if("?"==f[1]){l+=f+">\n"}else if(h=f.match(/^<(script|style|pre)/i)){h[1]=h[1].toLowerCase();f=this.tabifier.cleanTag(f);l=this.tabifier.placeTag(f,l);a=String(e.substr(i+1)).toLowerCase().indexOf("</"+h[1]);if(a){c=e.substr(i+1,a);i+=a;l+=c}}else{f=this.tabifier.cleanTag(f);l=this.tabifier.placeTag(f,l)}}return this.tabifier.finish(l)},getTabs:function(){var e="";for(var t=0;t<this.tabifier.cleanlevel;t++){e+=" "}return e},finish:function(e){e=e.replace(/\n\s*\n/g,"\n");e=e.replace(/^[\s\n]*/,"");e=e.replace(/[\s\n]*$/,"");e=e.replace(/<script(.*?)>\n<\/script>/gi,"<script$1></script>");this.tabifier.cleanlevel=0;return e},cleanTag:function(e){var t="";e=e.replace(/\n/g," ");e=e.replace(/\s{2,}/g," ");e=e.replace(/^\s+|\s+$/g," ");var n="";if(e.match(/\/$/)){n="/";e=e.replace(/\/+$/,"")}var r;while(r=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(e)){if(r[2])t+=r[1].toLowerCase()+"="+r[2];else if(r[1])t+=r[1].toLowerCase();t+=" ";e=e.substr(r[0].length)}return t.replace(/\s*$/,"")+n+">"},placeTag:function(e,t){var n=e.match(this.tabifier.newLevel);if(e.match(this.tabifier.lineBefore)||n){t=t.replace(/\s*$/,"");t+="\n"}if(n&&"/"==e.charAt(1))this.tabifier.cleanlevel--;if("\n"==t.charAt(t.length-1))t+=this.tabifier.getTabs();if(n&&"/"!=e.charAt(1))this.tabifier.cleanlevel++;t+=e;if(e.match(this.tabifier.lineAfter)||e.match(this.tabifier.newLevel)){t=t.replace(/ *$/,"");t+="\n"}return t}}},focus:function(){return{setStart:function(){this.$editor.focus();var e=this.$editor.children().first();if(e.size()===0)return;if(e[0].length===0||e[0].tagName=="BR"||e[0].nodeType==3){return}if(e[0].tagName=="UL"||e[0].tagName=="OL"){e=e.find("li").first()}if(this.opts.linebreaks&&!this.utils.isBlockTag(e[0].tagName)){this.selection.get();this.range.setStart(this.$editor[0],0);this.range.setEnd(this.$editor[0],0);this.selection.addRange();return}this.caret.setStart(e)},setEnd:function(){if(this.utils.browser("mozilla")||this.utils.browser("msie")){var e=this.$editor.children().last();this.caret.setEnd(e)}else{this.selection.get();try{this.range.selectNodeContents(this.$editor[0]);this.range.collapse(false);this.selection.addRange()}catch(t){}}},isFocused:function(){var t=document.getSelection().focusNode;if(t===null)return false;if(this.opts.linebreaks&&e(t.parentNode).hasClass("redactor-linebreaks"))return true;else if(!this.utils.isRedactorParent(t.parentNode))return false;return this.$editor.is(":focus")}}},placeholder:function(){return{enable:function(){if(!this.placeholder.is())return;this.$editor.attr("placeholder",this.$element.attr("placeholder"));this.placeholder.toggle();this.$editor.on("keyup.redactor-placeholder",e.proxy(this.placeholder.toggle,this))},toggle:function(){var e="removeClass";if(this.utils.isEmpty(this.$editor.html(),false))e="addClass";this.$editor[e]("redactor-placeholder")},remove:function(){this.$editor.removeClass("redactor-placeholder")},is:function(){if(this.opts.placeholder){return this.$element.attr("placeholder",this.opts.placeholder)}else{return!(typeof this.$element.attr("placeholder")=="undefined"||this.$element.attr("placeholder")==="")}}}},autosave:function(){return{enable:function(){if(!this.opts.autosave)return;this.autosave.html=false;this.autosave.name=this.opts.autosaveName?this.opts.autosaveName:this.$textarea.attr("name");if(!this.opts.autosaveOnChange){this.autosaveInterval=setInterval(e.proxy(this.autosave.load,this),this.opts.autosaveInterval*1e3)}},onChange:function(){if(!this.opts.autosaveOnChange)return;this.autosave.load()},load:function(){var t=this.code.get();if(this.autosave.html===t)return;if(this.utils.isEmpty(t))return;e.ajax({url:this.opts.autosave,type:"post",data:"name="+this.autosave.name+"&"+this.autosave.name+"="+escape(encodeURIComponent(t)),success:e.proxy(function(e){this.autosave.success(e,t)},this)})},success:function(t,n){var r;try{r=e.parseJSON(t)}catch(i){r=t}var s=typeof r.error=="undefined"?"autosave":"autosaveError";this.core.setCallback(s,this.autosave.name,r);this.autosave.html=n},disable:function(){clearInterval(this.autosaveInterval)}}},buffer:function(){return{set:function(e){if(typeof e=="undefined"||e=="undo"){this.buffer.setUndo()}else{this.buffer.setRedo()}},setUndo:function(){this.selection.save();this.opts.buffer.push(this.$editor.html());this.selection.restore()},setRedo:function(){this.selection.save();this.opts.rebuffer.push(this.$editor.html());this.selection.restore()},getUndo:function(){this.$editor.html(this.opts.buffer.pop())},getRedo:function(){this.$editor.html(this.opts.rebuffer.pop())},add:function(){this.opts.buffer.push(this.$editor.html())},undo:function(){if(this.opts.buffer.length===0)return;this.buffer.set("redo");this.buffer.getUndo();this.selection.restore();setTimeout(e.proxy(this.observe.load,this),50)},redo:function(){if(this.opts.rebuffer.length===0)return;this.buffer.set("undo");this.buffer.getRedo();this.selection.restore();setTimeout(e.proxy(this.observe.load,this),50)}}},indent:function(){return{increase:function(){if(!this.utils.browser("msie"))this.$editor.focus();this.buffer.set();this.selection.save();var e=this.selection.getBlock();if(e&&e.tagName=="LI"){this.indent.increaseLists()}else if(e===false&&this.opts.linebreaks){this.indent.increaseText()}else{this.indent.increaseBlocks()}this.selection.restore();this.code.sync()},increaseLists:function(){document.execCommand("indent");this.indent.fixEmptyIndent();this.clean.normalizeLists();this.clean.clearUnverified()},increaseBlocks:function(){e.each(this.selection.getBlocks(),e.proxy(function(e,t){if(t.tagName==="TD"||t.tagName==="TH")return;var n=this.utils.getAlignmentElement(t);var r=this.utils.normalize(n.css("margin-left"))+this.opts.indentValue;n.css("margin-left",r+"px")},this))},increaseText:function(){var t=this.selection.wrap("div");e(t).attr("data-tagblock","redactor");e(t).css("margin-left",this.opts.indentValue+"px")},decrease:function(){this.buffer.set();this.selection.save();var e=this.selection.getBlock();if(e&&e.tagName=="LI"){this.indent.decreaseLists()}else{this.indent.decreaseBlocks()}this.selection.restore();this.code.sync()},decreaseLists:function(){document.execCommand("outdent");var t=this.selection.getCurrent();var n=e(t).closest("li");var r=n.parent();if(n.size()!==0&&r.size()!==0&&r[0].tagName=="LI"){r.after(n)}this.indent.fixEmptyIndent();if(!this.opts.linebreaks&&n.size()===0){document.execCommand("formatblock",false,"p");this.$editor.find("ul, ol, blockquote, p").each(e.proxy(this.utils.removeEmpty,this))}this.clean.clearUnverified()},decreaseBlocks:function(){e.each(this.selection.getBlocks(),e.proxy(function(e,t){var n=this.utils.getAlignmentElement(t);var r=this.utils.normalize(n.css("margin-left"))-this.opts.indentValue;if(r<=0){if(this.opts.linebreaks&&typeof n.data("tagblock")!=="undefined"){n.replaceWith(n.html()+"<br />")}else{n.css("margin-left","");this.utils.removeEmptyAttr(n,"style")}}else{n.css("margin-left",r+"px")}},this))},fixEmptyIndent:function(){var t=this.selection.getBlock();if(this.range.collapsed&&t&&t.tagName=="LI"&&this.utils.isEmpty(e(t).text())){var n=e(t);n.find("span").not(".redactor-selection-marker").contents().unwrap();n.append("<br>")}}}},alignment:function(){return{left:function(){this.alignment.set("")},right:function(){this.alignment.set("right")},center:function(){this.alignment.set("center")},justify:function(){this.alignment.set("justify")},set:function(e){if(!this.utils.browser("msie"))this.$editor.focus();this.buffer.set();this.selection.save();this.alignment.blocks=this.selection.getBlocks();if(this.opts.linebreaks&&this.alignment.blocks[0]===false){this.alignment.setText(e)}else{this.alignment.setBlocks(e)}this.selection.restore();this.code.sync()},setText:function(t){var n=this.selection.wrap("div");e(n).attr("data-tagblock","redactor");e(n).css("text-align",t)},setBlocks:function(t){e.each(this.alignment.blocks,e.proxy(function(e,n){var r=this.utils.getAlignmentElement(n);if(!r)return;if(t===""&&typeof r.data("tagblock")!=="undefined"){r.replaceWith(r.html())}else{r.css("text-align",t);this.utils.removeEmptyAttr(r,"style")}},this))}}},paste:function(){return{init:function(t){if(!this.opts.cleanOnPaste)return;if(this.opts.clipboardImageUpload&&this.paste.detectEventClipboardUpload(t))return;this.rtePaste=true;this.buffer.set();this.selection.save();this.utils.saveScroll();this.paste.createPasteBox();e(window).on("scroll.redactor-freeze",e.proxy(function(){e(window).scrollTop(this.saveBodyScroll)},this));setTimeout(e.proxy(function(){var t=this.$pasteBox.html();this.$pasteBox.remove();this.selection.restore();this.utils.restoreScroll();this.paste.insert(t);e(window).off("scroll.redactor-freeze")},this),1)},createPasteBox:function(){this.$pasteBox=e("<div>").html(" ").attr("contenteditable","true").css({position:"fixed",width:0,top:0,left:"-9999px"});this.$pasteBox.appendTo(document.body);this.$pasteBox.focus()},insert:function(t){t=this.core.setCallback("pasteBefore",t);t=this.utils.isSelectAll()?this.clean.onPaste(t,false):this.clean.onPaste(t);t=this.core.setCallback("paste",t);if(this.utils.isSelectAll()){this.insert.set(t,false)}else{this.insert.html(t,false)}this.utils.disableSelectAll();this.rtePaste=false;if(this.utils.browser("mozilla"))setTimeout(e.proxy(this.paste.clipboardUploadInMozilla,this),100);setTimeout(e.proxy(this.clean.clearUnverified,this),10)},detectEventClipboardUpload:function(t){t=t.originalEvent||t;if(typeof t.clipboardData==="undefined")return;if(!t.clipboardData.items||!t.clipboardData.items.length)return;var n=t.clipboardData.items[0].getAsFile();if(n===null)return false;var r=new FileReader;r.onload=e.proxy(this.paste.insertFromClipboard,this);r.readAsDataURL(n);return true},clipboardUploadInMozilla:function(){var t=this.$editor.find("img");e.each(t,e.proxy(function(t,n){if(n.src.search(/^data\:image/i)==-1)return;var r=e(n);var i=n.src.split(",");var s={clipboard:1,contentType:i[0].split(";")[0].split(":")[1],data:i[1]};if(this.opts.uploadImageFields&&typeof this.opts.uploadImageFields==="object"){e.each(this.opts.uploadImageFields,e.proxy(function(t,n){if(n!==null&&n.toString().indexOf("#")===0)n=e(n).val();s[t]=n},this))}e.post(this.opts.imageUpload,s,e.proxy(function(t){var n=typeof t==="string"?e.parseJSON(t):t;r.attr("src",n.filelink);this.code.sync();this.core.setCallback("imageUpload",r,n);this.observe.images()},this))},this))},insertFromClipboard:function(e){var t=e.target.result;var n=t.split(",");var r=!!window.FormData?new FormData:null;if(!window.FormData)return;this.buffer.set();this.upload.direct=true;this.upload.type="image";this.upload.url=this.opts.imageUpload;this.upload.callback=this.image.insert;r.append("clipboard",1);r.append("contentType",n[0].split(";")[0].split(":")[1]);r.append("data",n[1]);this.upload.sendData(r,e)}}},keydown:function(){return{init:function(t){if(this.rtePaste)return;var n=t.which;var r=n>=37&&n<=40;this.keydown.ctrl=t.ctrlKey||t.metaKey;this.keydown.current=this.selection.getCurrent();this.keydown.parent=this.selection.getParent();this.keydown.block=this.selection.getBlock();this.keydown.pre=this.utils.isTag(this.keydown.current,"pre");this.keydown.blockquote=this.utils.isTag(this.keydown.current,"blockquote");this.keydown.figcaption=this.utils.isTag(this.keydown.current,"figcaption");this.shortcuts.init(t,n);this.keydown.checkEvents(r,n);this.keydown.setupBuffer(t,n);this.keydown.addArrowsEvent(r);this.keydown.setupSelectAll(t,n);var i=this.core.setCallback("keydown",t);if(i===false){t.preventDefault();return false}if(this.opts.enterKey&&n===this.keyCode.DOWN){this.keydown.onArrowDown()}if(!this.opts.enterKey&&n===this.keyCode.ENTER){t.preventDefault();if(!this.range.collapsed)this.range.deleteContents();return}if(n==this.keyCode.ENTER&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey){var s=this.core.setCallback("enter",t);if(s===false){t.preventDefault();return false}if(this.keydown.blockquote&&this.keydown.exitFromBlockquote(t)===true){return false}var o;if(this.keydown.pre){return this.keydown.insertNewLine(t)}else if(this.keydown.blockquote||this.keydown.figcaption){o=this.selection.getCurrent();var u=e(o).next();if(u.size()!==0&&u[0].tagName=="BR"){return this.keydown.insertBreakLine(t)}else if(this.utils.isEndOfElement()&&o&&o!="SPAN"){return this.keydown.insertDblBreakLine(t)}else{return this.keydown.insertBreakLine(t)}}else if(this.opts.linebreaks&&!this.keydown.block){o=this.selection.getCurrent();if(o!==0&&e(o).hasClass("redactor-invisible-space")){e(o).remove();return this.keydown.insertDblBreakLine(t)}else{return this.keydown.insertBreakLine(t)}}else if(this.opts.linebreaks&&this.keydown.block){setTimeout(e.proxy(this.keydown.replaceDivToBreakLine,this),1)}else if(!this.opts.linebreaks&&this.keydown.block){setTimeout(e.proxy(this.keydown.replaceDivToParagraph,this),1)}else if(!this.opts.linebreaks&&!this.keydown.block){return this.keydown.insertParagraph(t)}}if(n===this.keyCode.ENTER&&(t.ctrlKey||t.shiftKey)){return this.keydown.onShiftEnter(t)}if(n===this.keyCode.TAB||t.metaKey&&n===221||t.metaKey&&n===219){return this.keydown.onTab(t,n)}if(n===this.keyCode.BACKSPACE||n===this.keyCode.DELETE){var a=this.selection.getNodes();if(a){var f=a.length;var l;for(var c=0;c<f;c++){var h=e(a[c]).children("img");if(h.size()!==0){var p=this;e.each(h,function(t,n){var r=e(n);if(r.css("float")!="none")return;p.core.setCallback("imageDelete",n.src,r);l=n})}else if(a[c].tagName=="IMG"){if(l!=a[c]){this.core.setCallback("imageDelete",a[c].src,e(a[c]));l=a[c]}}}}}if(n===this.keyCode.BACKSPACE){this.keydown.removeInvisibleSpace();this.keydown.removeEmptyListInTable(t)}this.code.sync()},checkEvents:function(e,t){if(!e&&(this.core.getEvent()=="click"||this.core.getEvent()=="arrow")){this.core.addEvent(false);if(this.keydown.checkKeyEvents(t)){this.buffer.set()}}},checkKeyEvents:function(t){var n=this.keyCode;var r=[n.BACKSPACE,n.DELETE,n.ENTER,n.SPACE,n.ESC,n.TAB,n.CTRL,n.META,n.ALT,n.SHIFT];return e.inArray(t,r)==-1?true:false},addArrowsEvent:function(e){if(!e)return;if(this.core.getEvent()=="click"||this.core.getEvent()=="arrow"){this.core.addEvent(false);return}this.core.addEvent("arrow")},setupBuffer:function(e,t){if(this.keydown.ctrl&&t===90&&!e.shiftKey&&!e.altKey&&this.opts.buffer.length){e.preventDefault();this.buffer.undo();return}else if(this.keydown.ctrl&&t===90&&e.shiftKey&&!e.altKey&&this.opts.rebuffer.length!==0){e.preventDefault();this.buffer.redo();return}else if(!this.keydown.ctrl){if(t==this.keyCode.BACKSPACE||t==this.keyCode.DELETE||t==this.keyCode.ENTER&&!e.ctrlKey&&!e.shiftKey||t==this.keyCode.SPACE){this.buffer.set()}}},setupSelectAll:function(e,t){if(this.keydown.ctrl&&t===65){this.utils.enableSelectAll()}else if(t!=this.keyCode.LEFT_WIN&&!this.keydown.ctrl){this.utils.disableSelectAll()}},onArrowDown:function(){var e=[this.keydown.blockquote,this.keydown.pre,this.keydown.figcaption];for(var t=0;t<e.length;t++){if(e[t]){this.keydown.insertAfterLastElement(e[t]);return false}}},onShiftEnter:function(e){this.buffer.set();if(this.keydown.blockquote&&this.utils.isEndOfElement()){return this.keydown.insertDblBreakLine(e)}return this.keydown.insertBreakLine(e)},onTab:function(e,t){if(!this.opts.tabFocus)return true;if(this.utils.isEmpty(this.code.get())&&this.opts.tabAsSpaces===false)return true;e.preventDefault();var n;if(this.keydown.pre&&!e.shiftKey){n=this.opts.preSpaces?document.createTextNode(Array(this.opts.preSpaces+1).join(" ")):document.createTextNode("  ");this.insert.node(n);this.code.sync()}else if(this.opts.tabAsSpaces!==false){n=document.createTextNode(Array(this.opts.tabAsSpaces+1).join(" "));this.insert.node(n);this.code.sync()}else{if(e.metaKey&&t===219)this.indent.decrease();else if(e.metaKey&&t===221)this.indent.increase();else if(!e.shiftKey)this.indent.increase();else this.indent.decrease()}return false},replaceDivToBreakLine:function(){var t=this.selection.getBlock();var n=t.innerHTML.replace(/<br\s?\/?>/gi,"");if((t.tagName==="DIV"||t.tagName==="P")&&n===""&&!e(t).hasClass("redactor-editor")){var r=document.createElement("br");e(t).replaceWith(r);this.caret.setBefore(r);this.code.sync();return false}},replaceDivToParagraph:function(){var t=this.selection.getBlock();var n=t.innerHTML.replace(/<br\s?\/?>/gi,"");if(t.tagName==="DIV"&&n===""&&!e(t).hasClass("redactor-editor")){var r=document.createElement("p");r.innerHTML=this.opts.invisibleSpace;e(t).replaceWith(r);this.caret.setStart(r);this.code.sync();return false}else if(this.opts.cleanStyleOnEnter&&t.tagName=="P"){e(t).removeAttr("class").removeAttr("style")}},insertParagraph:function(e){e.preventDefault();this.selection.get();var t=document.createElement("p");t.innerHTML=this.opts.invisibleSpace;this.range.deleteContents();this.range.insertNode(t);this.caret.setStart(t);this.code.sync();return false},exitFromBlockquote:function(t){if(!this.utils.isEndOfElement())return;var n=e.trim(e(this.keydown.block).html());if(n.search(/(<br\s?\/?>){2}$/i)!=-1){t.preventDefault();if(this.opts.linebreaks){var r=document.createElement("br");e(this.keydown.blockquote).after(r);this.caret.setBefore(r);e(this.keydown.block).html(n.replace(/<br\s?\/?>$/i,""))}else{var i=e(this.opts.emptyHtml);e(this.keydown.blockquote).after(i);this.caret.setStart(i)}return true}return},insertAfterLastElement:function(t){if(!this.utils.isEndOfElement())return;this.buffer.set();if(this.opts.linebreaks){var n=e("<div>").append(e.trim(this.$editor.html())).contents();var r=n.last()[0];if(r.tagName=="SPAN"&&r.innerHTML===""){r=n.prev()[0]}if(this.utils.getOuterHtml(r)!=this.utils.getOuterHtml(t))return;var i=document.createElement("br");e(t).after(i);this.caret.setAfter(i)}else{if(this.$editor.contents().last()[0]!==t)return;var s=e(this.opts.emptyHtml);e(t).after(s);this.caret.setStart(s)}},insertNewLine:function(e){e.preventDefault();var t=document.createTextNode("\n");this.selection.get();this.range.deleteContents();this.range.insertNode(t);this.caret.setAfter(t);this.code.sync();return false},insertBreakLine:function(e){return this.keydown.insertBreakLineProcessing(e)},insertDblBreakLine:function(e){return this.keydown.insertBreakLineProcessing(e,true)},insertBreakLineProcessing:function(e,t){e.stopPropagation();this.selection.get();var n=document.createElement("br");this.range.deleteContents();this.range.insertNode(n);if(t===true){var r=document.createElement("br");this.range.insertNode(r);this.caret.setAfter(r)}else{this.caret.setAfter(n)}this.code.sync();return false},removeInvisibleSpace:function(){var t=e(this.keydown.current);if(t.text().search(/^\u200B$/g)===0){t.remove()}},removeEmptyListInTable:function(t){var n=e(this.keydown.current);var r=e(this.keydown.parent);var i=n.closest("td");if(i.size()!==0&&n.closest("li")&&r.children("li").size()===1){if(!this.utils.isEmpty(n.text()))return;t.preventDefault();n.remove();r.remove();this.caret.setStart(i)}}}},keyup:function(){return{init:function(t){if(this.rtePaste)return;var n=t.which;this.keyup.current=this.selection.getCurrent();this.keyup.parent=this.selection.getParent();var r=this.utils.isRedactorParent(e(this.keyup.parent).parent());var i=this.core.setCallback("keyup",t);if(i===false){t.preventDefault();return false}if(!this.opts.linebreaks&&this.keyup.current.nodeType==3&&this.keyup.current.length<=1&&(this.keyup.parent===false||this.keyup.parent.tagName=="BODY")){this.keyup.replaceToParagraph()}if(e(this.keyup.parent).hasClass("redactor-invisible-space")&&(r===false||r[0].tagName=="BODY")){e(this.keyup.parent).contents().unwrap();this.keyup.replaceToParagraph()}if(this.opts.convertLinks&&(this.opts.convertUrlLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&n===this.keyCode.ENTER){this.formatLinkify(this.opts.linkProtocol,this.opts.convertLinks,this.opts.convertUrlLinks,this.opts.convertImageLinks,this.opts.convertVideoLinks,this.opts.linkSize);this.observe.load();this.code.sync()}if(n===this.keyCode.DELETE||n===this.keyCode.BACKSPACE){this.clean.clearUnverified();if(this.observe.image){t.preventDefault();this.image.hideResize();this.buffer.set();this.image.remove(this.observe.image);this.observe.image=false;return false}this.$editor.find("p").each(e.proxy(this.utils.removeEmpty,this));if(this.keyup.current&&this.keyup.current.tagName=="DIV"&&this.utils.isEmpty(this.keyup.current.innerHTML)){if(this.opts.linebreaks){e(this.keyup.current).after(this.selection.getMarkerAsHtml());this.selection.restore();e(this.keyup.current).remove()}}return this.keyup.formatEmpty(t)}},replaceToParagraph:function(){var t=e(this.keyup.current);var n=e("<p>").append(t.clone());t.replaceWith(n);var r=e(n).next();if(typeof r[0]!=="undefined"&&r[0].tagName=="BR"){r.remove()}this.caret.setEnd(n)},formatEmpty:function(t){var n=e.trim(this.$editor.html());if(!this.utils.isEmpty(n))return;t.preventDefault();if(this.opts.linebreaks){if(!this.utils.browser("msie"))this.$editor.html("<br />");this.focus.setStart()}else{n="<p><br /></p>";this.$editor.html(n);this.focus.setStart()}this.code.sync();return false}}},shortcuts:function(){return{init:function(t,n){if(!this.opts.shortcuts){if((t.ctrlKey||t.metaKey)&&(n===66||n===73))t.preventDefault();return false}e.each(this.opts.shortcuts,e.proxy(function(n,r){var i=n.split(",");var s=i.length;for(var o=0;o<s;o++){if(typeof i[o]==="string"){this.shortcuts.handler(t,e.trim(i[o]),e.proxy(function(){var e;if(r.func.search(/\./)!="-1"){e=r.func.split(".");if(typeof this[e[0]]!="undefined"){this[e[0]][e[1]].apply(this,r.params)}}else{this[r.func].apply(this,r.params)}},this))}}},this))},handler:function(t,n,r){var i={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};var s={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"};n=n.toLowerCase().split(" ");var o=i[t.keyCode],u=String.fromCharCode(t.which).toLowerCase(),a="",f={};e.each(["alt","ctrl","meta","shift"],function(e,n){if(t[n+"Key"]&&o!==n){a+=n+"+"}});if(o)f[a+o]=true;if(u){f[a+u]=true;f[a+s[u]]=true;if(a==="shift+"){f[s[u]]=true}}for(var l=0,c=n.length;l<c;l++){if(f[n[l]]){t.preventDefault();return r.apply(this,arguments)}}}}},line:function(){return{insert:function(){this.buffer.set();var e=this.selection.getBlocks();if(e[0]!==false&&this.line.isExceptLastOrFirst(e)){if(!this.utils.browser("msie"))this.$editor.focus();return}if(this.utils.browser("msie")){this.line.insertInIe()}else{this.line.insertInOthersBrowsers()}},isExceptLastOrFirst:function(t){var n=["li","td","th","blockquote","figcaption","pre","dl","dt","dd"];var r=t[0].tagName.toLowerCase();var i=this.selection.getLastBlock();i=typeof i=="undefined"?r:i.tagName.toLowerCase();var s=e.inArray(r,n)!=-1;var o=e.inArray(i,n)!=-1;if(s&&o||s){return true}},insertInIe:function(){this.utils.saveScroll();this.buffer.set();this.insert.node(document.createElement("hr"));this.utils.restoreScroll();this.code.sync()},insertInOthersBrowsers:function(){this.buffer.set();var e='<p id="redactor-insert-line"><br /></p>';if(this.opts.linebreaks)e='<br id="redactor-insert-line">';document.execCommand("insertHTML",false,"<hr>"+e);this.line.setFocus();this.code.sync()},setFocus:function(){var t=this.$editor.find("#redactor-insert-line");var n=e(t).next()[0];if(n){this.caret.setAfter(t);t.remove()}else{t.removeAttr("id")}}}},list:function(){return{toggle:function(t){if(!this.utils.browser("msie"))this.$editor.focus();this.buffer.set();this.selection.save();var n=this.selection.getParent();var r=e(n).closest("ol, ul");if(!this.utils.isRedactorParent(r)&&r.size()!==0){r=false}var i,s;var o=false;if(r&&r.length){o=true;var u=r[0].tagName;i=t==="orderedlist"&&u==="UL";s=t==="unorderedlist"&&u==="OL"}if(i){this.utils.replaceToTag(r,"ol")}else if(s){this.utils.replaceToTag(r,"ul")}else{if(o){this.list.remove(t)}else{this.list.insert(t)}}this.selection.restore();this.code.sync()},insert:function(t){if(this.utils.browser("msie")&&this.opts.linebreaks){this.list.insertInIe(t)}else{document.execCommand("insert"+t)}var n=this.selection.getParent();var r=e(n).closest("ol, ul");if(!this.opts.linebreaks&&this.utils.isEmpty(r.find("li").text())){var i=r.children("li");i.find("br").remove();i.append(this.selection.getMarkerAsHtml())}if(r.length){var s=r.parent();if(this.utils.isRedactorParent(s)&&s[0].tagName!="LI"&&this.utils.isBlock(s[0])){s.replaceWith(s.contents())}}if(!this.utils.browser("msie")){this.$editor.focus()}this.clean.clearUnverified()},insertInIe:function(t){var n=this.selection.wrap("div");var r=e(n).html();var i=t=="orderedlist"?e("<ol>"):e("<ul>");var s=e("<li>");if(e.trim(r)===""){s.append(this.selection.getMarkerAsHtml());i.append(s);this.$editor.find("#selection-marker-1").replaceWith(i)}else{var o=r.split(/<br\s?\/?>/gi);if(o){for(var u=0;u<o.length;u++){if(e.trim(o[u])!==""){i.append(e("<li>").html(o[u]))}}}else{s.append(r);i.append(s)}e(n).replaceWith(i)}},remove:function(t){document.execCommand("insert"+t);var n=e(this.selection.getCurrent());this.indent.fixEmptyIndent();if(!this.opts.linebreaks&&n.closest("li, th, td").size()===0){document.execCommand("formatblock",false,"p");this.$editor.find("ul, ol, blockquote, p").each(e.proxy(this.utils.removeEmpty,this))}var r=e(this.selection.getCurrent()).closest("table");var i=r.prev();if(!this.opts.linebreaks&&r.size()!==0&&i.size()!==0&&i[0].tagName=="BR"){i.remove()}this.clean.clearUnverified()}}},block:function(){return{formatting:function(e){var t,n;if(typeof this.formatting[e].data!="undefined")t="data";else if(typeof this.formatting[e].attr!="undefined")t="attr";else if(typeof this.formatting[e].class!="undefined")t="class";if(t)n=this.formatting[e][t];this.block.format(this.formatting[e].tag,t,n)},format:function(t,n,r){if(t=="quote")t="blockquote";var i=["p","pre","blockquote","h1","h2","h3","h4","h5","h6"];if(e.inArray(t,i)==-1)return;this.block.isRemoveInline=t=="pre"||t.search(/h[1-6]/i)!=-1;if(!this.utils.browser("msie"))this.$editor.focus();this.block.blocks=this.selection.getBlocks();this.block.blocksSize=this.block.blocks.length;this.block.type=n;this.block.value=r;this.buffer.set();this.selection.save();this.block.set(t);this.selection.restore();this.code.sync()},set:function(e){this.selection.get();this.block.containerTag=this.range.commonAncestorContainer.tagName;if(this.range.collapsed){this.block.setCollapsed(e)}else{this.block.setMultiple(e)}},setCollapsed:function(t){var n=this.block.blocks[0];if(n===false)return;if(n.tagName=="LI"){if(t!="blockquote")return;this.block.formatListToBlockquote();return}var r=this.block.containerTag=="TD"||this.block.containerTag=="TH";if(r){if(!this.opts.linebreaks&&t=="p"){document.execCommand("formatblock",false,"<"+t+">");n=this.selection.getBlock();this.block.toggle(e(n))}}else if(n.tagName.toLowerCase()!=t){if(this.opts.linebreaks&&t=="p"){e(n).prepend("<br>").append("<br>");this.utils.replaceWithContents(n)}else{var i=this.utils.replaceToTag(n,t);this.block.toggle(i);if(t!="p"&&t!="blockquote")i.find("img").remove();if(this.block.isRemoveInline)this.utils.removeInlineTags(i);if(t=="p"||this.block.headTag)i.find("p").contents().unwrap()}}else if(t=="blockquote"&&n.tagName.toLowerCase()==t){if(this.opts.linebreaks){e(n).prepend("<br>").append("<br>");this.utils.replaceWithContents(n)}else{var s=this.utils.replaceToTag(n,"p");this.block.toggle(s)}}else if(n.tagName.toLowerCase()==t){this.block.toggle(e(n))}},setMultiple:function(t){var n=this.block.blocks[0];var r=this.block.containerTag=="TD"||this.block.containerTag=="TH";if(n!==false&&this.block.blocksSize===1){if(n.tagName.toLowerCase()==t&&t=="blockquote"){if(this.opts.linebreaks){e(n).prepend("<br>").append("<br>");this.utils.replaceWithContents(n)}else{var i=this.utils.replaceToTag(n,"p");this.block.toggle(i)}}else if(n.tagName=="LI"){if(t!="blockquote")return;this.block.formatListToBlockquote()}else if(this.block.containerTag=="BLOCKQUOTE"){this.block.formatBlockquote(t)}else if(this.opts.linebreaks&&(r||this.range.commonAncestorContainer!=n)){this.block.formatWrap(t)}else{if(this.opts.linebreaks&&t=="p"){e(n).prepend("<br>").append("<br>");this.utils.replaceWithContents(n)}else{var s=this.utils.replaceToTag(n,t);this.block.toggle(s);if(this.block.isRemoveInline)this.utils.removeInlineTags(s);if(t=="p"||this.block.headTag)s.find("p").contents().unwrap()}}}else{if(this.opts.linebreaks||t!="p"){if(t=="blockquote"){var o=0;for(var u=0;u<this.block.blocksSize;u++){if(this.block.blocks[u].tagName=="BLOCKQUOTE")o++}if(o==this.block.blocksSize){e.each(this.block.blocks,e.proxy(function(t,n){if(this.opts.linebreaks){e(n).prepend("<br>").append("<br>");this.utils.replaceWithContents(n)}else{this.utils.replaceToTag(n,"p")}},this));return}}this.block.formatWrap(t)}else{var a=0;var f=false;if(this.block.type=="class"){f="toggle";a=e(this.block.blocks).filter("."+this.block.value).size();if(this.block.blocksSize==a)f="toggle";else if(this.block.blocksSize>a)f="set";else if(a===0)f="set"}var l=["ul","ol","li","td","th","dl","dt","dd"];e.each(this.block.blocks,e.proxy(function(n,r){if(e.inArray(r.tagName.toLowerCase(),l)!=-1)return;var i=this.utils.replaceToTag(r,t);if(f){if(f=="toggle")this.block.toggle(i);else if(f=="remove")this.block.remove(i);else if(f=="set")this.block.set2(i)}else this.block.toggle(i);if(t!="p"&&t!="blockquote")i.find("img").remove();if(this.block.isRemoveInline)this.utils.removeInlineTags(i);if(t=="p"||this.block.headTag)i.find("p").contents().unwrap()},this))}}},toggle:function(e){if(this.block.type=="class"){e.toggleClass(this.block.value);return}else if(this.block.type=="attr"||this.block.type=="data"){if(e.attr(this.block.value.name)==this.block.value.value){e.removeAttr(this.block.value.name)}else{e.attr(this.block.value.name,this.block.value.value)}return}else{e.removeAttr("style class");return}},remove:function(e){e.removeClass(this.block.value)},formatListToBlockquote:function(){var t=e(this.block.blocks[0]).closest("ul, ol");e(t).find("ul, ol").contents().unwrap();e(t).find("li").append(e("<br>")).contents().unwrap();var n=this.utils.replaceToTag(t,"blockquote");this.block.toggle(n)},formatBlockquote:function(t){document.execCommand("outdent");document.execCommand("formatblock",false,t);this.clean.clearUnverified();this.$editor.find("p:empty").remove();var n=this.selection.getBlock();if(t!="p"){e(n).find("img").remove()}if(!this.opts.linebreaks){this.block.toggle(e(n))}this.$editor.find("ul, ol, tr, blockquote, p").each(e.proxy(this.utils.removeEmpty,this));if(this.opts.linebreaks&&t=="p"){this.utils.replaceWithContents(n)}},formatWrap:function(t){if(this.block.containerTag=="UL"||this.block.containerTag=="OL"){if(t=="blockquote"){this.block.formatListToBlockquote()}else{return}}var n=this.selection.wrap(t);if(n===false)return;var r=e(n);this.block.formatTableWrapping(r);var i=r.find(this.opts.blockLevelElements.join(",")+", td, table, thead, tbody, tfoot, th, tr");if(this.opts.linebreaks&&t=="p"||t=="pre"||t=="blockquote"){i.append("<br />")}i.contents().unwrap();if(t!="p"&&t!="blockquote")r.find("img").remove();e.each(this.block.blocks,e.proxy(this.utils.removeEmpty,this));r.append(this.selection.getMarker(2));if(!this.opts.linebreaks){this.block.toggle(r)}this.$editor.find("ul, ol, tr, blockquote, p").each(e.proxy(this.utils.removeEmpty,this));r.find("blockquote:empty").remove();if(this.block.isRemoveInline){this.utils.removeInlineTags(r)}if(this.opts.linebreaks&&t=="p"){this.utils.replaceWithContents(r)}},formatTableWrapping:function(e){if(e.closest("table").size()===0)return;if(e.closest("tr").size()===0)e.wrap("<tr>");if(e.closest("td").size()===0)e.wrap("<td>")},removeData:function(t,n){var r=this.selection.getBlocks();e(r).removeAttr("data-"+t);this.code.sync()},setData:function(t,n){var r=this.selection.getBlocks();e(r).attr("data-"+t,n);this.code.sync()},toggleData:function(t,n){var r=this.selection.getBlocks();e.each(r,function(){if(e(this).attr("data-"+t)){e(this).removeAttr("data-"+t)}else{e(this).attr("data-"+t,n)}})},removeAttr:function(t,n){var r=this.selection.getBlocks();e(r).removeAttr(t);this.code.sync()},setAttr:function(t,n){var r=this.selection.getBlocks();e(r).attr(t,n);this.code.sync()},toggleAttr:function(t,n){var r=this.selection.getBlocks();e.each(r,function(){if(e(this).attr(name)){e(this).removeAttr(name)}else{e(this).attr(name,n)}})},removeClass:function(t){var n=this.selection.getBlocks();e(n).removeClass(t);this.utils.removeEmptyAttr(n,"class");this.code.sync()},setClass:function(t){var n=this.selection.getBlocks();e(n).addClass(t);this.code.sync()},toggleClass:function(t){var n=this.selection.getBlocks();e(n).toggleClass(t);this.code.sync()}}},inline:function(){return{formatting:function(e){var t,n;if(typeof this.formatting[e].style!="undefined")t="style";else if(typeof this.formatting[e].class!="undefined")t="class";if(t)n=this.formatting[e][t];this.inline.format(this.formatting[e].tag,t,n)},format:function(e,t,n){if(this.utils.isCurrentOrParent("PRE"))return;var r=["b","bold","i","italic","underline","strikethrough","deleted","superscript","subscript"];var i=["strong","strong","em","em","u","del","del","sup","sub"];for(var s=0;s<r.length;s++){if(e==r[s])e=i[s]}this.inline.type=t||false;this.inline.value=n||false;this.buffer.set();this.$editor.focus();this.selection.get();if(this.range.collapsed){this.inline.formatCollapsed(e)}else{this.inline.formatMultiple(e)}},formatCollapsed:function(t){var n=this.selection.getCurrent();var r=e(n).closest(t+"[data-redactor-tag="+t+"]");if(r.size()!==0){this.caret.setAfter(r[0]);if(this.utils.isEmpty(r.text()))r.remove();this.code.sync();return}var i=e("<"+t+">").attr("data-verified","redactor").attr("data-redactor-tag",t);i.html(this.opts.invisibleSpace);i=this.inline.setFormat(i);this.insert.node(i);this.caret.setEnd(i);this.code.sync();return},formatMultiple:function(t){this.inline.formatConvert(t);this.selection.save();document.execCommand("strikethrough");this.$editor.find("strike").each(e.proxy(function(n,r){var i=e(r);this.inline.formatRemoveSameChildren(i,t);var s;if(this.inline.type){s=e("<span>").attr("data-redactor-tag",t).attr("data-verified","redactor");s=this.inline.setFormat(s)}else{s=e("<"+t+">").attr("data-redactor-tag",t).attr("data-verified","redactor")}i.replaceWith(s.html(i.contents()));if(t=="span"){var o=s.parent();if(o&&o[0].tagName=="SPAN"&&this.inline.type=="style"){var u=this.inline.value.split(";");for(var a=0;a<u.length;a++){if(u[a]==="")return;var f=u[a].split(":");o.css(f[0],"");if(this.utils.removeEmptyAttr(o,"style")){o.replaceWith(o.contents())}}}}},this));if(t!="del"){var n=this;this.$editor.find("inline").each(function(e,t){n.utils.replaceToTag(t,"del")})}this.selection.restore();this.code.sync()},formatRemoveSameChildren:function(t,n){t.children(n).each(function(){var t=e(this);if(!t.hasClass("redactor-selection-marker")){t.contents().unwrap()}})},formatConvert:function(t){this.selection.save();var n="";if(this.inline.type=="class")n="[data-redactor-class="+this.inline.value+"]";else if(this.inline.type=="style"){n='[data-redactor-style="'+this.inline.value+'"]'}if(t!="del"){var r=this;this.$editor.find("del").each(function(e,t){r.utils.replaceToTag(t,"inline")})}this.$editor.find('[data-redactor-tag="'+t+'"]'+n).each(function(){if(n===""&&t=="span"&&this.tagName.toLowerCase()==t)return;var r=e(this);r.replaceWith(e("<strike />").html(r.contents()))});this.selection.restore()},setFormat:function(e){switch(this.inline.type){case"class":if(e.hasClass(this.inline.value)){e.removeClass(this.inline.value);e.removeAttr("data-redactor-class")}else{e.addClass(this.inline.value);e.attr("data-redactor-class",this.inline.value)}break;case"style":e[0].style.cssText=this.inline.value;e.attr("data-redactor-style",this.inline.value);break}return e},removeStyle:function(){this.buffer.set();var t=this.selection.getCurrent();var n=this.selection.getInlines();this.selection.save();if(t&&t.tagName==="SPAN"){var r=e(t);r.removeAttr("style");if(r[0].attributes.length===0){r.replaceWith(r.contents())}}e.each(n,e.proxy(function(t,n){var r=e(n);if(e.inArray(n.tagName.toLowerCase(),this.opts.inlineTags)!=-1&&!r.hasClass("redactor-selection-marker")){r.removeAttr("style");if(r[0].attributes.length===0){r.replaceWith(r.contents())}}},this));this.selection.restore();this.code.sync()},removeStyleRule:function(t){this.buffer.set();var n=this.selection.getParent();var r=this.selection.getInlines();this.selection.save();if(n&&n.tagName==="SPAN"){var i=e(n);i.css(t,"");this.utils.removeEmptyAttr(i,"style");if(i[0].attributes.length===0){i.replaceWith(i.contents())}}e.each(r,e.proxy(function(n,r){var i=e(r);if(e.inArray(r.tagName.toLowerCase(),this.opts.inlineTags)!=-1&&!i.hasClass("redactor-selection-marker")){i.css(t,"");this.utils.removeEmptyAttr(i,"style");if(i[0].attributes.length===0){i.replaceWith(i.contents())}}},this));this.selection.restore();this.code.sync()},removeFormat:function(){this.buffer.set();var t=this.selection.getCurrent();this.selection.save();document.execCommand("removeFormat");if(t&&t.tagName==="SPAN"){e(t).replaceWith(e(t).contents())}e.each(this.selection.getNodes(),e.proxy(function(t,n){var r=e(n);if(e.inArray(n.tagName.toLowerCase(),this.opts.inlineTags)!=-1&&!r.hasClass("redactor-selection-marker")){r.replaceWith(r.contents())}},this));this.selection.restore();this.code.sync()},toggleClass:function(e){this.inline.format("span","class",e)},toggleStyle:function(e){this.inline.format("span","style",e)}}},insert:function(){return{set:function(t,n){this.placeholder.remove();t=this.clean.setVerified(t);if(typeof n=="undefined"){t=this.clean.onPaste(t,false)}this.$editor.html(t);this.selection.remove();this.focus.setEnd();this.clean.normalizeLists();this.code.sync();this.observe.load();if(typeof n=="undefined"){setTimeout(e.proxy(this.clean.clearUnverified,this),10)}},text:function(t){this.placeholder.remove();t=t.toString();t=e.trim(t);t=this.clean.getPlainText(t,false);this.$editor.focus();if(this.utils.browser("msie")){this.insert.htmlIe(t)}else{if(this.$editingHTML){var n=this.$textarea.val();var r=n.substr(0,this.$textarea[0].selectionStart)+t+n.substr(this.$textarea[0].selectionEnd,n.length);this.$textarea.val(r)}else{this.selection.get();this.range.deleteContents();var i=document.createElement("div");i.innerHTML=t;var s=document.createDocumentFragment(),o,u;while(o=i.firstChild){u=s.appendChild(o)}this.range.insertNode(s);if(u){var a=this.range.cloneRange();this.$range=a;a.setStartAfter(u);a.collapse(true);this.sel.removeAllRanges();this.sel.addRange(a)}}}this.code.sync();this.clean.clearUnverified()},html:function(t,n){this.placeholder.remove();if(typeof n=="undefined")n=true;this.$editor.focus();t=this.clean.setVerified(t);if(n){t=this.clean.onPaste(t)}if(this.utils.browser("msie")){this.insert.htmlIe(t)}else{if(this.clean.singleLine)this.insert.execHtml(t);else document.execCommand("insertHTML",null,t);this.insert.htmlFixMozilla()}this.clean.normalizeLists();if(!this.opts.linebreaks){this.$editor.find("p").each(e.proxy(this.utils.removeEmpty,this))}this.code.sync();this.observe.load();if(n){this.clean.clearUnverified()}},htmlFixMozilla:function(){if(!this.utils.browser("mozilla"))return;var t=e(this.selection.getBlock()).next();if(t.length>0&&t[0].tagName=="P"&&t.html()===""){t.remove()}},htmlIe:function(t){if(this.utils.isIe11()){var n=this.utils.isCurrentOrParent("P");var r=e("<div>").append(t);var i=r.contents().is("p, :header, dl, ul, ol, div, table, td, blockquote, pre, address, section, header, footer, aside, article");if(n&&i)this.insert.ie11FixInserting(n,t);else this.insert.ie11PasteFrag(t);return}document.selection.createRange().pasteHTML(t)},execHtml:function(e){e=this.clean.setVerified(e);this.selection.get();this.range.deleteContents();var t=document.createElement("div");t.innerHTML=e;var n=document.createDocumentFragment(),r,i;while(r=t.firstChild){i=n.appendChild(r)}this.range.insertNode(n);this.range.collapse(true);this.caret.setAfter(i)},node:function(e){e=e[0]||e;this.selection.get();this.range.deleteContents();this.range.insertNode(e);this.range.collapse(false);this.selection.addRange();return e},nodeToPoint:function(e,t,n){e=e[0]||e;this.selection.get();var r;if(document.caretPositionFromPoint){var i=document.caretPositionFromPoint(t,n);this.range.setStart(i.offsetNode,i.offset);this.range.collapse(true);this.range.insertNode(e)}else if(document.caretRangeFromPoint){r=document.caretRangeFromPoint(t,n);r.insertNode(e)}else if(typeof document.body.createTextRange!="undefined"){r=document.body.createTextRange();r.moveToPoint(t,n);var s=r.duplicate();s.moveToPoint(t,n);r.setEndPoint("EndToEnd",s);r.select()}},nodeToCaretPositionFromPoint:function(e,t){t=t[0]||t;var n;var r=e.clientX,i=e.clientY;if(document.caretPositionFromPoint){var s=document.caretPositionFromPoint(r,i);var o=document.getSelection();n=o.getRangeAt(0);n.setStart(s.offsetNode,s.offset);n.collapse(true);n.insertNode(t)}else if(document.caretRangeFromPoint){n=document.caretRangeFromPoint(r,i);n.insertNode(t)}else if(typeof document.body.createTextRange!="undefined"){n=document.body.createTextRange();n.moveToPoint(r,i);var u=n.duplicate();u.moveToPoint(r,i);n.setEndPoint("EndToEnd",u);n.select()}},ie11FixInserting:function(t,n){var r=document.createElement("span");r.className="redactor-ie-paste";this.insert.node(r);var i=e(t).html();i="<p>"+i.replace(/<span class="redactor-ie-paste"><\/span>/gi,"</p>"+n+"<p>")+"</p>";e(t).replaceWith(i)},ie11PasteFrag:function(e){this.selection.get();this.range.deleteContents();var t=document.createElement("div");t.innerHTML=e;var n=document.createDocumentFragment(),r,i;while(r=t.firstChild){i=n.appendChild(r)}this.range.insertNode(n)}}},caret:function(){return{setStart:function(t){if(!this.utils.isBlock(t)){var n=this.utils.createSpaceElement();e(t).prepend(n);this.caret.setEnd(n)}else{this.caret.set(t,0,t,0)}},setEnd:function(e){this.caret.set(e,1,e,1)},set:function(t,n,r,i){if(!this.utils.browser("msie"))this.$editor.focus();t=t[0]||t;r=r[0]||r;if(this.utils.isBlockTag(t.tagName)&&t.innerHTML===""){t.innerHTML=this.opts.invisibleSpace}if(t.tagName=="BR"&&this.opts.linebreaks===false){var s=e(this.opts.emptyHtml)[0];e(t).replaceWith(s);t=s;r=t}this.selection.get();try{this.range.setStart(t,n);this.range.setEnd(r,i)}catch(o){}this.selection.addRange()},setAfter:function(t){var n=e(t)[0].tagName;if(n!="BR"&&!this.utils.isBlock(t)){var r=this.utils.createSpaceElement();e(t).after(r);this.caret.setEnd(r)}else{if(n!="BR"&&this.utils.browser("msie")){this.caret.setStart(e(t).next())}else{this.caret.setAfterOrBefore(t,"after")}}},setBefore:function(t){if(this.utils.isBlock(t)){this.caret.setEnd(e(t).prev())}else{this.caret.setAfterOrBefore(t,"before")}},setAfterOrBefore:function(e,t){if(!this.utils.browser("msie"))this.$editor.focus();e=e[0]||e;this.selection.get();if(t=="after"){try{this.range.setStartAfter(e);this.range.setEndAfter(e)}catch(n){}}else{try{this.range.setStartBefore(e);this.range.setEndBefore(e)}catch(n){}}this.range.collapse(false);this.selection.addRange()},getOffsetOfElement:function(t){t=t[0]||t;this.selection.get();var n=this.range.cloneRange();n.selectNodeContents(t);n.setEnd(this.range.endContainer,this.range.endOffset);return e.trim(n.toString()).length},getOffset:function(){var e=0;var t=window.getSelection();if(t.rangeCount>0){var n=window.getSelection().getRangeAt(0);var r=n.cloneRange();r.selectNodeContents(this.$editor[0]);r.setEnd(n.endContainer,n.endOffset);e=r.toString().length}return e},setOffset:function(e,t){if(typeof t=="undefined")t=e;if(!this.focus.isFocused())this.focus.setStart();var n=document.createRange();var r=document.getSelection();var i,s=0;var o=document.createTreeWalker(this.$editor[0],NodeFilter.SHOW_TEXT,null,null);while(i=o.nextNode()){s+=i.nodeValue.length;if(s>e){n.setStart(i,i.nodeValue.length+e-s);e=Infinity}if(s>=t){n.setEnd(i,i.nodeValue.length+t-s);break}}r.removeAllRanges();r.addRange(n)},setToPoint:function(e,t){this.caret.setOffset(e,t)},getCoords:function(){return this.caret.getOffset()}}},selection:function(){return{get:function(){this.sel=document.getSelection();if(document.getSelection&&this.sel.getRangeAt&&this.sel.rangeCount){this.range=this.sel.getRangeAt(0)}else{this.range=document.createRange()}},addRange:function(){try{this.sel.removeAllRanges()}catch(e){}this.sel.addRange(this.range)},getCurrent:function(){var e=false;this.selection.get();if(this.sel&&this.sel.rangeCount>0){e=this.sel.getRangeAt(0).startContainer}return this.utils.isRedactorParent(e)},getParent:function(t){t=t||this.selection.getCurrent();if(t){return this.utils.isRedactorParent(e(t).parent()[0])}return false},getBlock:function(t){t=t||this.selection.getCurrent();while(t){if(this.utils.isBlockTag(t.tagName)){return e(t).hasClass("redactor-editor")?false:t}t=t.parentNode}return false},getInlines:function(t){this.selection.get();if(this.range&&this.range.collapsed){return false}var n=[];t=typeof t=="undefined"?this.selection.getNodes():t;var r=this.opts.inlineTags;r.push("span");e.each(t,e.proxy(function(t,i){if(e.inArray(i.tagName.toLowerCase(),r)!=-1){n.push(i)}},this));return n.length===0?false:n},getBlocks:function(t){this.selection.get();if(this.range&&this.range.collapsed){return[this.selection.getBlock()]}var n=[];t=typeof t=="undefined"?this.selection.getNodes():t;e.each(t,e.proxy(function(e,t){if(this.utils.isBlock(t)){this.selection.lastBlock=t;n.push(t)}},this));return n.length===0?[this.selection.getBlock()]:n},getLastBlock:function(){return this.selection.lastBlock},getNodes:function(){this.selection.get();var t=this.selection.getNodesMarker(1);var n=this.selection.getNodesMarker(2);this.selection.setNodesMarker(this.range,t,true);if(this.range.collapsed===false){this.selection.setNodesMarker(this.range,n,false)}else{n=t}var r=[];var i=0;var s=this;this.$editor.find("*").each(function(){if(this==t){var o=e(this).parent();if(o.length!==0&&o[0].tagName!="BODY"&&s.utils.isRedactorParent(o[0])){r.push(o[0])}r.push(this);i=1}else{if(i>0){r.push(this);i=i+1}}if(this==n){return false}});var o=[];var u=r.length;for(var a=0;a<u;a++){if(r[a].id!="nodes-marker-1"&&r[a].id!="nodes-marker-2"){o.push(r[a])}}this.selection.removeNodesMarkers();return o},getNodesMarker:function(t){return e('<span id="nodes-marker-'+t+'" class="redactor-nodes-marker" data-verified="redactor">'+this.opts.invisibleSpace+"</span>")[0]},setNodesMarker:function(e,t,n){e=e.cloneRange();try{e.collapse(n);e.insertNode(t)}catch(r){}},removeNodesMarkers:function(){e(document).find("span.redactor-nodes-marker").remove();this.$editor.find("span.redactor-nodes-marker").remove()},fromPoint:function(e,t){this.caret.setOffset(e,t)},wrap:function(e){this.selection.get();if(this.range.collapsed)return false;var t=document.createElement(e);t.appendChild(this.range.extractContents());this.range.insertNode(t);return t},selectElement:function(e){this.caret.set(e,0,e,1)},selectAll:function(){this.selection.get();this.range.selectNodeContents(this.$editor[0]);this.selection.addRange()},remove:function(){this.selection.get();this.sel.removeAllRanges()},save:function(){this.selection.createMarkers()},createMarkers:function(){this.selection.get();var e=this.selection.getMarker(1);this.selection.setMarker(this.range,e,true);if(this.range.collapsed===false){var t=this.selection.getMarker(2);this.selection.setMarker(this.range,t,false)}this.savedSel=this.$editor.html()},saveOnly:function(){this.selection.get();var e=this.selection.getMarker(1);this.savedSel=this.$editor.html()},getMarker:function(t){if(typeof t=="undefined")t=1;return e('<span id="selection-marker-'+t+'" class="redactor-selection-marker"  data-verified="redactor">'+this.opts.invisibleSpace+"</span>")[0]},getMarkerAsHtml:function(e){return this.utils.getOuterHtml(this.selection.getMarker(e))},setMarker:function(e,t,n){e=e.cloneRange();try{e.collapse(n);e.insertNode(t)}catch(r){this.focus.setStart()}},restore:function(){var e=this.$editor.find("span#selection-marker-1");var t=this.$editor.find("span#selection-marker-2");if(e.length!==0&&t.length!==0){this.caret.set(e,0,t,0)}else if(e.length!==0){this.caret.set(e,0,e,0)}else{this.$editor.focus()}this.selection.removeMarkers();this.savedSel=false},restoreOnly:function(){if(this.$range){var t=e(this.$range.startContainer);var n=e(this.$range.endContainer);if(t.length!==0&&n.length!==0){this.caret.set(t,this.$range.startOffset,n,this.$range.endOffset)}else if(t.length!==0){this.caret.set(t,0,t,0)}else{this.$editor.focus()}}else{this.caret.set(this.$editor,0,this.$editor,0)}this.selection.removeMarkers();this.savedSel=false},removeMarkers:function(){this.$editor.find("span.redactor-selection-marker").remove()},getText:function(){this.selection.get();return this.sel.toString()},getHtml:function(){var e="";this.selection.get();if(this.sel.rangeCount){var t=document.createElement("div");var n=this.sel.rangeCount;for(var r=0;r<n;++r){t.appendChild(this.sel.getRangeAt(r).cloneContents())}e=t.innerHTML}return this.clean.onSync(e)}}},observe:function(){return{load:function(){this.observe.images();this.observe.links()},buttons:function(t,n){var r=this.selection.getCurrent();var i=this.selection.getParent();this.button.setInactiveAll(n);if(t===false&&n!=="html"){if(e.inArray(n,this.opts.activeButtons)!=-1)this.button.toggleActive(n);return}var s=this.utils.isCurrentOrParent("A")?this.lang.get("link_edit"):this.lang.get("link_insert");e("body").find("a.redactor-dropdown-link").text(s);e.each(this.opts.activeButtonsStates,e.proxy(function(t,n){if(e(i).closest(t).length!==0||e(r).closest(t).length!==0){this.button.setActive(n)}},this));var o=e(i).closest(this.opts.alignmentTags.toString().toLowerCase());if(o.length){var u=o.css("text-align")===""?"left":o.css("text-align");this.button.setActive("align"+u)}},addButton:function(e,t){this.opts.activeButtons.push(t);this.opts.activeButtonsStates[e]=t},images:function(){this.$editor.find("img").each(e.proxy(function(t,n){var r=e(n);r.closest("a").on("click",function(e){e.preventDefault()});if(this.utils.browser("msie"))r.attr("unselectable","on");this.image.setEditable(r)},this));e(document).on("click.redactor-image-delete",e.proxy(function(e){this.observe.image=false;if(e.target.tagName=="IMG"&&this.utils.isRedactorParent(e.target)){this.observe.image=this.observe.image&&this.observe.image==e.target?false:e.target}},this))},links:function(){if(!this.opts.linkTooltip)return;this.$editor.find("a").on("touchstart click",e.proxy(this.observe.showTooltip,this));this.$editor.on("touchstart click.redactor",e.proxy(this.observe.closeTooltip,this));e(document).on("touchstart click.redactor",e.proxy(this.observe.closeTooltip,this))},getTooltipPosition:function(e){return e.offset()},showTooltip:function(t){var n=e(t.target);if(n.size()===0||n[0].tagName!=="A")return;var r=this.observe.getTooltipPosition(n);var i=e('<span class="redactor-link-tooltip"></span>');var s=n.attr("href");if(s===undefined){s=""}if(s.length>24)s=s.substring(0,24)+"...";var o=e('<a href="'+n.attr("href")+'" target="_blank" />').html(s).addClass("redactor-link-tooltip-action");var u=e('<a href="#" />').html(this.lang.get("edit")).on("click",e.proxy(this.link.show,this)).addClass("redactor-link-tooltip-action");var a=e('<a href="#" />').html(this.lang.get("unlink")).on("click",e.proxy(this.link.unlink,this)).addClass("redactor-link-tooltip-action");i.append(o).append(" | ").append(u).append(" | ").append(a);i.css({top:r.top+20+"px",left:r.left+"px"});e(".redactor-link-tooltip").remove();e("body").append(i)},closeTooltip:function(t){t=t.originalEvent||t;if(t.target.tagName=="A"&&!e(t.target).hasClass("redactor-link-tooltip-action")&&this.utils.isRedactorParent(t.target)){return}e(".redactor-link-tooltip").remove()}}},link:function(){return{show:function(t){if(typeof t!="undefined"&&t.preventDefault)t.preventDefault();this.modal.load("link",this.lang.get("link_insert"),600);this.modal.createCancelButton();this.link.buttonInsert=this.modal.createActionButton(this.lang.get("insert"));this.selection.get();this.link.getData();this.link.cleanUrl();if(this.link.target=="_blank")e("#redactor-link-blank").prop("checked",true);this.link.$inputUrl=e("#redactor-link-url");this.link.$inputText=e("#redactor-link-url-text");this.link.$inputText.val(this.link.text);this.link.$inputUrl.val(this.link.url);this.link.buttonInsert.on("click",e.proxy(this.link.insert,this));this.selection.save();this.modal.show();this.link.$inputUrl.focus()},cleanUrl:function(){var e=self.location.href.replace(/\/$/i,"");this.link.url=this.link.url.replace(e,"");this.link.url=this.link.url.replace(/^\/#/,"#");this.link.url=this.link.url.replace("mailto:","");if(!this.opts.linkProtocol){var t=new RegExp("^(http|ftp|https)://"+self.location.host,"i");this.link.url=this.link.url.replace(t,"")}},getData:function(){this.link.$node=false;var t=e(this.selection.getCurrent()).closest("a");if(t.size()!==0&&t[0].tagName==="A"){this.link.$node=t;this.link.url=t.attr("href");this.link.text=t.text();this.link.target=t.attr("target")}else{this.link.text=this.sel.toString();this.link.url="";this.link.target=""}},insert:function(){var t="";var n=this.link.$inputUrl.val();var r=this.link.$inputText.val();if(e.trim(n)===""){this.link.$inputUrl.addClass("redactor-input-error").on("keyup",function(){e(this).removeClass("redactor-input-error");e(this).off("keyup")});return}if(n.search("@")!=-1&&/(http|ftp|https):\/\//i.test(n)===false){n="mailto:"+n}else if(n.search("#")!==0){if(e("#redactor-link-blank").prop("checked")){t="_blank"}var i="((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}";var s=new RegExp("^(http|ftp|https)://"+i,"i");var o=new RegExp("^"+i,"i");if(n.search(s)==-1&&n.search(o)===0&&this.opts.linkProtocol){n=this.opts.linkProtocol+"://"+n}}this.link.set(r,n,t);this.modal.close()},set:function(t,n,r){t=e.trim(t.replace(/<|>/g,""));this.selection.restore();if(t==="")return;if(this.link.$node){this.buffer.set();this.link.$node.text(t).attr("href",n);if(r!==""){this.link.$node.attr("target",r)}else{this.link.$node.removeAttr("target")}this.code.sync()}else{document.execCommand("createLink",false,n);var i=e(this.selection.getCurrent()).closest("a");if(r!==""){i.attr("target",r)}i.removeAttr("style");this.code.sync();this.core.setCallback("insertedLink",i)}setTimeout(e.proxy(function(){this.observe.links()},this),5)},unlink:function(t){if(typeof t!="undefined"&&t.preventDefault)t.preventDefault();var n=this.selection.getNodes();if(!n)return;this.buffer.set();var r=n.length;for(var i=0;i<r;i++){if(n[i].tagName=="A"){var s=e(n[i]);s.replaceWith(s.contents())}}e(".redactor-link-tooltip").remove();this.code.sync()}}},image:function(){return{show:function(){this.modal.load("image",this.lang.get("image"),700);this.upload.init("#redactor-modal-image-droparea",this.opts.imageUpload,this.image.insert);this.selection.save();this.modal.show()},showEdit:function(t){var n=t.closest("a");this.modal.load("imageEdit",this.lang.get("edit"),705);this.modal.createCancelButton();this.image.buttonDelete=this.modal.createDeleteButton(this.lang.get("_delete"));this.image.buttonSave=this.modal.createActionButton(this.lang.get("save"));this.image.buttonDelete.on("click",e.proxy(function(){this.image.remove(t)},this));this.image.buttonSave.on("click",e.proxy(function(){this.image.update(t)},this));e("#redactor-image-title").val(t.attr("alt"));if(!this.opts.imageLink)e(".redactor-image-link-option").hide();else{var r=e("#redactor-image-link");r.attr("href",t.attr("src"));if(n.size()!==0){r.val(n.attr("href"));if(n.attr("target")=="_blank")e("#redactor-image-link-blank").prop("checked",true)}}if(!this.opts.imagePosition)e(".redactor-image-position-option").hide();else{var i=t.css("display")=="block"&&t.css("float")=="none"?"center":t.css("float");e("#redactor-image-align").val(i)}this.modal.show()},setFloating:function(t){var n=e("#redactor-image-align").val();var r="";var i="";var s="";switch(n){case"left":r="left";s="0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+" 0";break;case"right":r="right";s="0 0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin;break;case"center":i="block";s="auto";break}t.css({"float":r,display:i,margin:s});t.attr("rel",t.attr("style"))},update:function(t){this.image.hideResize();this.buffer.set();var n=t.closest("a");t.attr("alt",e("#redactor-image-title").val());this.image.setFloating(t);var r=e.trim(e("#redactor-image-link").val());if(r!==""){var i=e("#redactor-image-link-blank").prop("checked")?true:false;if(n.size()===0){var s=e('<a href="'+r+'">'+this.utils.getOuterHtml(t)+"</a>");if(i)s.attr("target","_blank");t.replaceWith(s)}else{n.attr("href",r);if(i){n.attr("target","_blank")}else{n.removeAttr("target")}}}else if(n.size()!==0){n.replaceWith(this.utils.getOuterHtml(t))}this.modal.close();this.observe.images();this.code.sync()},setEditable:function(t){if(!this.opts.imageEditable)return;t.on("dragstart",e.proxy(this.image.onDrag,this));t.on("mousedown",e.proxy(this.image.hideResize,this));t.on("click touchstart",e.proxy(function(n){this.observe.image=t;if(this.$editor.find("#redactor-image-box").size()!==0)return false;if(!this.opts.imageResizable)return;this.image.resizer=this.image.loadEditableControls(t);this.image.resizer.on("mousedown.redactor touchstart.redactor",e.proxy(function(e){e.preventDefault();this.image.resizeHandle={x:e.pageX,y:e.pageY,el:t,ratio:t.width()/t.height(),h:t.height()};e=e.originalEvent||e;if(e.targetTouches){this.image.resizeHandle.x=e.targetTouches[0].pageX;this.image.resizeHandle.y=e.targetTouches[0].pageY}this.image.startResize()},this));e(document).on("click.redactor-image-resize-hide",e.proxy(this.image.hideResize,this));this.$editor.on("click.redactor-image-resize-hide",e.proxy(this.image.hideResize,this))},this))},startResize:function(){e(document).on("mousemove.redactor-image-resize touchmove.redactor-image-resize",e.proxy(this.image.moveResize,this));e(document).on("mouseup.redactor-image-resize touchend.redactor-image-resize",e.proxy(this.image.stopResize,this))},moveResize:function(e){e.preventDefault();e=e.originalEvent||e;var t=this.image.resizeHandle.h;if(e.targetTouches)t+=e.targetTouches[0].pageY-this.image.resizeHandle.y;else t+=e.pageY-this.image.resizeHandle.y;var n=Math.round(t*this.image.resizeHandle.ratio);if(t<50||n<100)return;this.image.resizeHandle.el.height(t);this.image.resizeHandle.el.width(n);this.code.sync()},stopResize:function(){this.handle=false;e(document).off(".redactor-image-resize");this.image.hideResize()},onDrag:function(t){if(this.$editor.find("#redactor-image-box").size()!==0){t.preventDefault();return false}this.$editor.on("drop.redactor-image-inside-drop",e.proxy(function(){setTimeout(e.proxy(this.image.onDrop,this),1)},this))},onDrop:function(){this.image.fixImageSourceAfterDrop();this.observe.images();this.$editor.off("drop.redactor-image-inside-drop");this.clean.clearUnverified();this.code.sync()},fixImageSourceAfterDrop:function(){this.$editor.find("img[data-save-url]").each(function(){var t=e(this);t.attr("src",t.attr("data-save-url"));t.removeAttr("data-save-url")})},hideResize:function(t){if(t&&e(t.target).closest("#redactor-image-box").length!==0)return;if(t&&t.target.tagName=="IMG"){var n=e(t.target);n.attr("data-save-url",n.attr("src"))}var r=this.$editor.find("#redactor-image-box");if(r.size()===0)return;this.image.editter.remove();this.image.resizer.remove();r.find("img").css({marginTop:r[0].style.marginTop,marginBottom:r[0].style.marginBottom,marginLeft:r[0].style.marginLeft,marginRight:r[0].style.marginRight});r.css("margin","");r.find("img").css("opacity","");r.replaceWith(function(){return e(this).contents()});e(document).off("click.redactor-image-resize-hide");this.$editor.off("click.redactor-image-resize-hide");this.code.sync()},loadEditableControls:function(t){var n=e('<span id="redactor-image-box" data-redactor="verified">');n.css({position:"relative",display:"inline-block",lineHeight:0,outline:"1px dashed rgba(0, 0, 0, .6)","float":t.css("float")});n.attr("contenteditable",false);if(t[0].style.margin!="auto"){n.css({marginTop:t[0].style.marginTop,marginBottom:t[0].style.marginBottom,marginLeft:t[0].style.marginLeft,marginRight:t[0].style.marginRight});t.css("margin","")}else{n.css({display:"block",margin:"auto"})}t.css("opacity",".5").after(n);this.image.editter=e('<span id="redactor-image-editter" data-redactor="verified">'+this.lang.get("edit")+"</span>");this.image.editter.css({position:"absolute",zIndex:5,top:"50%",left:"50%",marginTop:"-11px",marginLeft:"-18px",lineHeight:1,backgroundColor:"#000",color:"#fff",fontSize:"11px",padding:"7px 10px",cursor:"pointer"});this.image.editter.attr("contenteditable",false);this.image.editter.on("click",e.proxy(function(){this.image.showEdit(t)},this));n.append(this.image.editter);var r=this.image.editter.innerWidth();this.image.editter.css("margin-left","-"+r/2+"px");if(this.opts.imageResizable&&!this.utils.isMobile()){var i=e('<span id="redactor-image-resizer" data-redactor="verified"></span>');i.css({position:"absolute",zIndex:2,lineHeight:1,cursor:"nw-resize",bottom:"-4px",right:"-5px",border:"1px solid #fff",backgroundColor:"#000",width:"8px",height:"8px"});if(!this.utils.isDesktop()){i.css({width:"15px",height:"15px"})}i.attr("contenteditable",false);n.append(i);n.append(t);return i}else{n.append(t);return false}},remove:function(t){var n=e(t);var r=n.closest("a");var i=n.closest("figure");var s=n.parent();if(e("#redactor-image-box").size()!==0){s=e("#redactor-image-box").parent()}var o;if(i.size()!==0){o=i.next();i.remove()}else if(r.size()!==0){s=r.parent();r.remove()}else{n.remove()}e("#redactor-image-box").remove();if(i.size()!==0){this.caret.setStart(o)}else{this.caret.setStart(s)}this.core.setCallback("imageDelete",n[0].src,n);this.modal.close();this.code.sync()},insert:function(t,n,r){if(typeof t.error!="undefined"){this.modal.close();this.selection.restore();this.core.setCallback("imageUploadError",t);return}var i;if(typeof t=="string"){i=e(t).attr("data-redactor-inserted-image","true")}else{i=e("<img>");i.attr("src",t.filelink).attr("data-redactor-inserted-image","true")}var s=i;var o=this.utils.isCurrentOrParent("P");if(o){s=e("<blockquote />").append(i)}if(n){this.selection.removeMarkers();var u=this.selection.getMarker();this.insert.nodeToCaretPositionFromPoint(r,u)}else{this.modal.close()}this.selection.restore();this.buffer.set();this.insert.html(this.utils.getOuterHtml(s));var a=this.$editor.find("img[data-redactor-inserted-image=true]").removeAttr("data-redactor-inserted-image");if(o){a.parent().contents().unwrap().wrap("<p />")}else if(this.opts.linebreaks){a.before("<br>").after("<br>")}if(typeof t=="string")return;this.core.setCallback("imageUpload",a,t)}}},file:function(){return{show:function(){this.modal.load("file",this.lang.get("file"),700);this.upload.init("#redactor-modal-file-upload",this.opts.fileUpload,this.file.insert);this.selection.save();this.selection.get();var t=this.sel.toString();e("#redactor-filename").val(t);this.modal.show()},insert:function(t,n,r){if(typeof t.error!="undefined"){this.modal.close();this.selection.restore();this.core.setCallback("fileUploadError",t);return}var i;if(typeof t=="string"){i=t}else{var s=e("#redactor-filename").val();if(typeof s=="undefined"||s==="")s=t.filename;i='<a href="'+t.filelink+'" id="filelink-marker">'+s+"</a>"}if(n){this.selection.removeMarkers();var o=this.selection.getMarker();this.insert.nodeToCaretPositionFromPoint(r,o)}else{this.modal.close()}this.selection.restore();this.buffer.set();this.insert.html(i);if(typeof t=="string")return;var u=e(this.$editor.find("a#filelink-marker"));if(u.size()!==0)u.removeAttr("id");else u=false;this.core.setCallback("fileUpload",u,t)}}},modal:function(){return{callbacks:{},loadTemplates:function(){this.opts.modal={imageEdit:String()+'<section id="redactor-modal-image-edit">'+"<label>"+this.lang.get("title")+"</label>"+'<input type="text" id="redactor-image-title" />'+'<label class="redactor-image-link-option">'+this.lang.get("link")+"</label>"+'<input type="text" id="redactor-image-link" class="redactor-image-link-option" />'+'<label class="redactor-image-link-option"><input type="checkbox" id="redactor-image-link-blank"> '+this.lang.get("link_new_tab")+"</label>"+'<label class="redactor-image-position-option">'+this.lang.get("image_position")+"</label>"+'<select class="redactor-image-position-option" id="redactor-image-align">'+'<option value="none">'+this.lang.get("none")+"</option>"+'<option value="left">'+this.lang.get("left")+"</option>"+'<option value="center">'+this.lang.get("center")+"</option>"+'<option value="right">'+this.lang.get("right")+"</option>"+"</select>"+"</section>",image:String()+'<section id="redactor-modal-image-insert">'+'<div id="redactor-modal-image-droparea"></div>'+"</section>",file:String()+'<section id="redactor-modal-file-insert">'+'<div id="redactor-modal-file-upload-box">'+"<label>"+this.lang.get("filename")+"</label>"+'<input type="text" id="redactor-filename" /><br><br>'+'<div id="redactor-modal-file-upload"></div>'+"</div>"+"</section>",link:String()+'<section id="redactor-modal-link-insert">'+"<label>URL</label>"+'<input type="url" id="redactor-link-url" />'+"<label>"+this.lang.get("text")+"</label>"+'<input type="text" id="redactor-link-url-text" />'+'<label><input type="checkbox" id="redactor-link-blank"> '+this.lang.get("link_new_tab")+"</label>"+"</section>"};e.extend(this.opts,this.opts.modal)},addCallback:function(e,t){this.modal.callbacks[e]=t},createTabber:function(t){this.modal.$tabber=e("<div>").attr("id","redactor-modal-tabber");t.prepend(this.modal.$tabber)},addTab:function(t,n,r){var i=e('<a href="#" rel="tab'+t+'">').text(n);if(r){i.addClass("active")}var s=this;i.on("click",function(t){t.preventDefault();e(".redactor-tab").hide();e(".redactor-"+e(this).attr("rel")).show();s.modal.$tabber.find("a").removeClass("active");e(this).addClass("active")});this.modal.$tabber.append(i)},addTemplate:function(e,t){this.opts.modal[e]=t},getTemplate:function(e){return this.opts.modal[e]},getModal:function(){return this.$modalBody.find("section")},load:function(e,t,n){this.modal.templateName=e;this.modal.width=n;this.modal.build();this.modal.enableEvents();this.modal.setTitle(t);this.modal.setDraggable();this.modal.setContent();if(typeof this.modal.callbacks[e]!="undefined"){this.modal.callbacks[e].call(this)}},show:function(){this.modal.bodyOveflow=e(document.body).css("overflow");e(document.body).css("overflow","hidden");if(this.utils.isMobile()){this.modal.showOnMobile()}else{this.modal.showOnDesktop()}this.$modalOverlay.show();this.$modalBox.show();this.modal.setButtonsWidth();this.utils.saveScroll();if(!this.utils.isMobile()){setTimeout(e.proxy(this.modal.showOnDesktop,this),0);e(window).on("resize.redactor-modal",e.proxy(this.modal.resize,this))}this.core.setCallback("modalOpened",this.modal.templateName,this.$modal);e(document).off("focusin.modal");this.$modal.find("input[type=text]").on("keypress.redactor-modal",e.proxy(this.modal.setEnter,this))},showOnDesktop:function(){var t=this.$modal.outerHeight();var n=e(window).height();var r=e(window).width();if(this.modal.width>r){this.$modal.css({width:"96%",marginTop:n/2-t/2+"px"});return}if(t>n){this.$modal.css({width:this.modal.width+"px",marginTop:"20px"})}else{this.$modal.css({width:this.modal.width+"px",marginTop:n/2-t/2+"px"})}},showOnMobile:function(){this.$modal.css({width:"96%",marginTop:"2%"})},resize:function(){if(this.utils.isMobile()){this.modal.showOnMobile()}else{this.modal.showOnDesktop()}},setTitle:function(e){this.$modalHeader.html(e)},setContent:function(){this.$modalBody.html(this.modal.getTemplate(this.modal.templateName))},setDraggable:function(){if(typeof e.fn.draggable==="undefined")return;this.$modal.draggable({handle:this.$modalHeader});this.$modalHeader.css("cursor","move")},setEnter:function(e){if(e.which!=13)return;e.preventDefault();this.$modal.find("button.redactor-modal-action-btn").click()},createCancelButton:function(){var t=e("<button>").addClass("redactor-modal-btn redactor-modal-close-btn").html(this.lang.get("cancel"));t.on("click",e.proxy(this.modal.close,this));this.$modalFooter.append(t)},createDeleteButton:function(e){return this.modal.createButton(e,"delete")},createActionButton:function(e){return this.modal.createButton(e,"action")},createButton:function(t,n){var r=e("<button>").addClass("redactor-modal-btn").addClass("redactor-modal-"+n+"-btn").html(t);this.$modalFooter.append(r);return r},setButtonsWidth:function(){var e=this.$modalFooter.find("button");var t=e.size();if(t===0)return;e.css("width",100/t+"%")},build:function(){this.modal.buildOverlay();this.$modalBox=e('<div id="redactor-modal-box" />').hide();this.$modal=e('<div id="redactor-modal" />');this.$modalHeader=e("<header />");this.$modalClose=e('<span id="redactor-modal-close" />').html("&times;");this.$modalBody=e('<div id="redactor-modal-body" />');this.$modalFooter=e("<footer />");this.$modal.append(this.$modalHeader);this.$modal.append(this.$modalClose);this.$modal.append(this.$modalBody);this.$modal.append(this.$modalFooter);this.$modalBox.append(this.$modal);this.$modalBox.appendTo(document.body)},buildOverlay:function(){this.$modalOverlay=e('<div id="redactor-modal-overlay">').hide();e("body").prepend(this.$modalOverlay)},enableEvents:function(){this.$modalClose.on("click.redactor-modal",e.proxy(this.modal.close,this));e(document).on("keyup.redactor-modal",e.proxy(this.modal.closeHandler,this));this.$editor.on("keyup.redactor-modal",e.proxy(this.modal.closeHandler,this));this.$modalBox.on("click.redactor-modal",e.proxy(this.modal.close,this))},disableEvents:function(){this.$modalClose.off("click.redactor-modal");e(document).off("keyup.redactor-modal");this.$editor.off("keyup.redactor-modal");this.$modalBox.off("click.redactor-modal");e(window).off("resize.redactor-modal")},closeHandler:function(e){if(e.which!=this.keyCode.ESC)return;this.modal.close(false)},close:function(t){if(t){if(!e(t.target).hasClass("redactor-modal-close-btn")&&t.target!=this.$modalClose[0]&&t.target!=this.$modalBox[0]){return}t.preventDefault()}if(!this.$modalBox)return;this.modal.disableEvents();this.$modalOverlay.remove();this.$modalBox.fadeOut("fast",e.proxy(function(){this.$modalBox.remove();setTimeout(e.proxy(this.utils.restoreScroll,this),0);if(t!==undefined)this.selection.restore();e(document.body).css("overflow",this.modal.bodyOveflow);this.core.setCallback("modalClosed",this.modal.templateName)},this))}}},progress:function(){return{show:function(){e(document.body).append(e('<div id="redactor-progress"><span></span></div>'));e("#redactor-progress").fadeIn()},hide:function(){e("#redactor-progress").fadeOut(1500,function(){e(this).remove()})}}},upload:function(){return{init:function(t,n,r){this.upload.direct=false;this.upload.callback=r;this.upload.url=n;this.upload.$el=e(t);this.upload.$droparea=e('<div id="redactor-droparea" />');this.upload.$placeholdler=e('<div id="redactor-droparea-placeholder" />').text("Drop file here or ");this.upload.$input=e('<input type="file" name="file" />');this.upload.$placeholdler.append(this.upload.$input);this.upload.$droparea.append(this.upload.$placeholdler);this.upload.$el.append(this.upload.$droparea);this.upload.$droparea.off("redactor.upload");this.upload.$input.off("redactor.upload");this.upload.$droparea.on("dragover.redactor.upload",e.proxy(this.upload.onDrag,this));this.upload.$droparea.on("dragleave.redactor.upload",e.proxy(this.upload.onDragLeave,this));this.upload.$input.on("change.redactor.upload",e.proxy(function(e){e=e.originalEvent||e;this.upload.traverseFile(this.upload.$input[0].files[0],e)},this));this.upload.$droparea.on("drop.redactor.upload",e.proxy(function(e){e.preventDefault();this.upload.$droparea.removeClass("drag-hover").addClass("drag-drop");this.upload.onDrop(e)},this))},directUpload:function(e,t){this.upload.direct=true;this.upload.traverseFile(e,t)},onDrop:function(e){e=e.originalEvent||e;var t=e.dataTransfer.files;this.upload.traverseFile(t[0],e)},traverseFile:function(e,t){if(this.opts.s3){this.upload.setConfig(e);this.upload.s3uploadFile(e);return}var n=!!window.FormData?new FormData:null;if(window.FormData){this.upload.setConfig(e);var r=this.upload.type=="image"?this.opts.imageUploadParam:this.opts.fileUploadParam;n.append(r,e)}this.progress.show();this.upload.sendData(n,t)},setConfig:function(e){this.upload.getType(e);if(this.upload.direct){this.upload.url=this.upload.type=="image"?this.opts.imageUpload:this.opts.fileUpload;this.upload.callback=this.upload.type=="image"?this.image.insert:this.file.insert}},getType:function(e){this.upload.type="image";if(this.opts.imageTypes.indexOf(e.type)==-1){this.upload.type="file"}},getHiddenFields:function(t,n){if(t===false||typeof t!=="object")return n;e.each(t,e.proxy(function(t,r){if(r!==null&&r.toString().indexOf("#")===0)r=e(r).val();n.append(t,r)},this));return n},sendData:function(t,n){if(this.upload.type=="image"){t=this.upload.getHiddenFields(this.opts.uploadImageFields,t);t=this.upload.getHiddenFields(this.upload.imageFields,t)}else{t=this.upload.getHiddenFields(this.opts.uploadFileFields,t);t=this.upload.getHiddenFields(this.upload.fileFields,t)}var r=new XMLHttpRequest;r.open("POST",this.upload.url);r.onreadystatechange=e.proxy(function(){if(r.readyState==4){var t=r.responseText;t=t.replace(/^\[/,"");t=t.replace(/\]$/,"");var i=typeof t==="string"?e.parseJSON(t):t;this.progress.hide();if(!this.upload.direct){this.upload.$droparea.removeClass("drag-drop")}this.upload.callback(i,this.upload.direct,n)}},this);r.send(t)},onDrag:function(e){e.preventDefault();this.upload.$droparea.addClass("drag-hover")},onDragLeave:function(e){e.preventDefault();this.upload.$droparea.removeClass("drag-hover")},clearImageFields:function(){this.upload.imageFields={}},addImageFields:function(e,t){this.upload.imageFields[e]=t},removeImageFields:function(e){delete this.upload.imageFields[e]},clearFileFields:function(){this.upload.fileFields={}},addFileFields:function(e,t){this.upload.fileFields[e]=t},removeFileFields:function(e){delete this.upload.fileFields[e]},s3uploadFile:function(t){this.upload.s3executeOnSignedUrl(t,e.proxy(function(e){this.upload.s3uploadToS3(t,e)},this))},s3executeOnSignedUrl:function(e,t){var n=new XMLHttpRequest;var r="?";if(this.opts.s3.search(/\?/)!="-1")r="&";n.open("GET",this.opts.s3+r+"name="+e.name+"&type="+e.type,true);if(n.overrideMimeType)n.overrideMimeType("text/plain; charset=x-user-defined");var i=this;n.onreadystatechange=function(e){if(this.readyState==4&&this.status==200){i.progress.show();t(decodeURIComponent(this.responseText))}else if(this.readyState==4&&this.status!=200){}};n.send()},s3createCORSRequest:function(e,t){var n=new XMLHttpRequest;if("withCredentials"in n){n.open(e,t,true)}else if(typeof XDomainRequest!="undefined"){n=new XDomainRequest;n.open(e,t)}else{n=null}return n},s3uploadToS3:function(t,n){var r=this.upload.s3createCORSRequest("PUT",n);if(!r){}else{r.onload=e.proxy(function(){if(r.status==200){this.progress.hide();var e=n.split("?");if(!e[0]){return false}if(!this.upload.direct){this.upload.$droparea.removeClass("drag-drop")}var t={filelink:e[0]};if(this.upload.type=="file"){var i=e[0].split("/");t.filename=i[i.length-1]}this.upload.callback(t,this.upload.direct,false)}else{}},this);r.onerror=function(){};r.upload.onprogress=function(e){};r.setRequestHeader("Content-Type",t.type);r.setRequestHeader("x-amz-acl","public-read");r.send(t)}}}},utils:function(){return{isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},isDesktop:function(){return!/(iPhone|iPod|iPad|BlackBerry|Android)/.test(navigator.userAgent)},isString:function(e){return Object.prototype.toString.call(e)=="[object String]"},isEmpty:function(t,n){t=t.replace(/[\u200B-\u200D\uFEFF]/g,"");t=t.replace(/&nbsp;/gi,"");t=t.replace(/<\/?br\s?\/?>/g,"");t=t.replace(/\s/g,"");t=t.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,"");if(n!==false){t=t.replace(/<[^\/>][^>]*><\/[^>]+>/gi,"");t=t.replace(/<[^\/>][^>]*><\/[^>]+>/gi,"")}t=e.trim(t);return t===""},normalize:function(e){if(typeof e==="undefined")return 0;return parseInt(e.replace("px",""),10)},hexToRgb:function(e){if(typeof e=="undefined")return;if(e.search(/^#/)==-1)return e;var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,function(e,t,n,r){return t+t+n+n+r+r});var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return"rgb("+parseInt(n[1],16)+", "+parseInt(n[2],16)+", "+parseInt(n[3],16)+")"},getOuterHtml:function(t){return e("<div>").append(e(t).eq(0).clone()).html()},getAlignmentElement:function(t){if(e.inArray(t.tagName,this.opts.alignmentTags)!==-1){return e(t)}else{return e(t).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}},removeEmptyAttr:function(t,n){var r=e(t);if(typeof r.attr(n)=="undefined"){return true}if(r.attr(n)===""){r.removeAttr(n);return true}return false},removeEmpty:function(t,n){var r=e(n);var i=e.trim(r.text());if(r.children("hr, br, img").length!==0)return;if(this.utils.isEmpty(i,false)){r.remove()}},saveScroll:function(){if(this.utils.isSelectAll())return;this.saveEditorScroll=this.$editor.scrollTop();this.saveBodyScroll=e(window).scrollTop();if(this.opts.scrollTarget)this.saveTargetScroll=e(this.opts.scrollTarget).scrollTop()},restoreScroll:function(){if(!this.saveScroll&&!this.saveBodyScroll)return;e(window).scrollTop(this.saveBodyScroll);this.$editor.scrollTop(this.saveEditorScroll);if(this.opts.scrollTarget)e(this.opts.scrollTarget).scrollTop(this.saveTargetScroll)},createSpaceElement:function(){var e=document.createElement("span");e.className="redactor-invisible-space";e.innerHTML=this.opts.invisibleSpace;return e},removeInlineTags:function(t){var n=this.opts.inlineTags;n.push("span");if(t.tagName=="PRE")n.push("a");e(t).find(n.join(",")).not("span.redactor-selection-marker").contents().unwrap()},replaceWithContents:function(t,n){var r=this;e(t).replaceWith(function(){if(n===true)r.utils.removeInlineTags(this);return e(this).contents()})},replaceToTag:function(t,n,r){var i;var s=this;e(t).replaceWith(function(){i=e("<"+n+" />").append(e(this).contents());for(var t=0;t<this.attributes.length;t++){i.attr(this.attributes[t].name,this.attributes[t].value)}if(r===true)s.utils.removeInlineTags(i);return i});return i},isStartOfElement:function(){var e=this.selection.getBlock();if(!e)return false;var t=this.caret.getOffsetOfElement(e);return t===0?true:false},isEndOfElement:function(){var t=this.selection.getBlock();if(!t)return false;var n=this.caret.getOffsetOfElement(t);var r=e.trim(e(t).text()).replace(/\n\r\n/g,"");var i=r.length;return n==i?true:false},isBlock:function(e){e=e[0]||e;return e&&this.utils.isBlockTag(e.tagName)},isBlockTag:function(e){if(typeof e=="undefined")return false;return this.reIsBlock.test(e)},isTag:function(t,n){var r=e(t).closest(n);if(r.size()==1){return r[0]}return false},isSelectAll:function(){return this.selectAll},enableSelectAll:function(){this.selectAll=true},disableSelectAll:function(){this.selectAll=false},isRedactorParent:function(t){if(!t){return false}if(e(t).parents(".redactor-editor").length===0||e(t).hasClass("redactor-editor")){return false}return t},isCurrentOrParent:function(t){var n=this.selection.getParent();var r=this.selection.getCurrent();if(e.isArray(t)){var i=0;e.each(t,e.proxy(function(e,t){if(this.utils.isCurrentOrParentOne(r,n,t)){i++}},this));return i===0?false:true}else{return this.utils.isCurrentOrParentOne(r,n,t)}},isCurrentOrParentOne:function(e,t,n){return t&&t.tagName===n?t:e&&e.tagName===n?e:false},isOldIe:function(){return this.utils.browser("msie")&&parseInt(this.utils.browser("version"),10)<9?true:false},isLessIe10:function(){return this.utils.browser("msie")&&parseInt(this.utils.browser("version"),10)<10?true:false},isIe11:function(){return!!navigator.userAgent.match(/Trident\/7\./)},browser:function(e){var t=navigator.userAgent.toLowerCase();var n=/(opr)[\/]([\w.]+)/.exec(t)||/(chrome)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[];if(e=="version")return n[2];if(e=="webkit")return n[1]=="chrome"||n[1]=="webkit";if(n[1]=="rv")return e=="msie";if(n[1]=="opr")return e=="webkit";return e==n[1]}}}};i.prototype.init.prototype=i.prototype;e.Redactor.fn.formatLinkify=function(t,i,s,o,u,a){var f="((?:http[s]?:\\/\\/(?:www\\.)?|www\\.){1}(?:[0-9A-Za-z\\-%_]+\\.)+[a-zA-Z]{2,}(?::[0-9]+)?(?:(?:/[0-9A-Za-z\\-\\.%_]*)+)?(?:\\?(?:[0-9A-Za-z\\-\\.%_]+(?:=[0-9A-Za-z\\-\\.%_\\+]*)?)?(?:&(?:[0-9A-Za-z\\-\\.%_]+(?:=[0-9A-Za-z\\-\\.%_\\+]*)?)?)*)?(?:#[0-9A-Za-z\\-\\.%_\\+=\\?&;]*)?)";var l=new RegExp(f,"gi");var c=/(https?|ftp):\/\//i;var h=/(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/gi;var p=(this.$editor?this.$editor[0]:this).childNodes,d=p.length;while(d--){var v=p[d];if(v.nodeType===3){var m=v.nodeValue;if(u&&m){var g='<iframe width="500" height="281" src="',y='" frameborder="0" allowfullscreen></iframe>';if(m.match(n)){m=m.replace(n,g+"//www.youtube.com/embed/$1"+y);e(v).after(m).remove()}else if(m.match(r)){m=m.replace(r,g+"//player.vimeo.com/video/$2"+y);e(v).after(m).remove()}}if(o&&m&&m.match(h)){m=m.replace(h,'<img src="$1">');e(v).after(m).remove()}if(m.search(/\$/g)!=-1)m=m.replace(/\$/g,"&#36;");var b=m.match(l);if(s&&m&&b){var w=b.length;for(var E=0;E<w;E++){if(b[E].match(/\.$/)!==null)b[E]=b[E].replace(/\.$/,"");var S=b[E];var x=S;var T="";if(S.match(/\s$/)!==null)T=" ";var N=t+"://";if(S.match(c)!==null)N="";if(x.length>a)x=x.substring(0,a)+"...";x=x.replace(/&#36;/g,"$").replace(/&/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;");m=m.replace(S,'<a href="'+N+e.trim(S)+'">'+e.trim(x)+"</a>"+T)}e(v).after(m).remove()}}else if(v.nodeType===1&&!/^(a|button|textarea)$/i.test(v.tagName)){e.Redactor.fn.formatLinkify.call(v,t,i,s,o,u,a)}}}})(jQuery)
